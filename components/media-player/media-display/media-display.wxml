<!-- components/media-display/media-display.wxml -->
<wxs src="./url-cleaner.wxs" module="urlCleaner"></wxs>
<view
class="media-container"
catchtap="onScreenTap"
>  
  <!-- Media content -->
  <swiper
    class="media-swiper"
    wx:if="{{ currentPost.type === 'image' }}"
    current="{{ currentSlideIndex }}"
    bindchange="onSlideChange"
    circular="{{ false }}"
    indicator-dots="{{ mediaLength > 1 }}"
    indicator-color="rgba(255,255,255,0.3)"
    indicator-active-color="#ffffff"
  >
    <swiper-item wx:for="{{ currentMedia }}" wx:key="id" class="media-item">
      <view class="media-wrapper">
        <image
          class="media-image"
          id="media-image"
          src="{{ urlCleaner.cleanUrl(item.url) }}"
          data-src="{{ urlCleaner.cleanUrl(item.url) }}"
          mode="aspectFit"
          lazy-load="{{ true }}"
          bindload="onImageLoad"
        />
      </view>
      <view
        wx:if="{{ calculatedDots && calculatedDots.length > 0 && !isPlaying && index === currentSlideIndex }}"
        class="dots-overlay"
      >
        <view
          wx:for="{{ calculatedDots }}"
          wx:for-item="dot"
          wx:for-index="dotIndex"
          wx:key="index"
          class="interactive-dot {{selectedDot && selectedDot.id === dot.id ? 'active' : ''}}"
          style="left: {{dot.leftPercent}}%; top: {{dot.topPercent}}%;"
          data-index="{{ dot.index }}"
          catchtap="onDotTap"
        >
          <view class="dot-pulse"></view>
          <view class="dot-core"></view>
        </view>
      </view>
    </swiper-item>
  </swiper>  <!-- Video display with thumbnail background -->
  <view wx:elif="{{ currentPost.type === 'video' }}" class="video-wrapper">
    <!-- Thumbnail background -->
    <image
      class="video-thumbnail-background"
      src="{{ urlCleaner.cleanUrl(currentMedia[0].preview_url || currentMedia[0].thumbnail_url || currentMedia[0].url) }}"
      mode="aspectFill"
      lazy-load="{{ true }}"
    />
    
    <!-- Video container for proper sizing -->
    <view class="video-container">
      <video
        id="media-video"
        class="media-video"
        src="{{ videoSrc }}"
        poster="{{ urlCleaner.cleanUrl(currentMedia[0].preview_url || currentMedia[0].thumbnail_url || currentMedia[0].url) }}"
        controls="{{ true }}"
        show-controls="{{ true }}"
        enable-progress-gesture="{{ true }}"
        show-play-btn="{{ true }}"
        autoplay="{{ false }}"
        loop="{{ true }}"
        muted="{{ !isPlaying }}"
        initial-time="0"
        auto-pause-if-navigate="{{ true }}"
        auto-pause-if-open-native="{{ true }}"
        show-loading="{{ false }}"
        show-fullscreen-btn="{{ true }}"
        show-center-play-btn="{{ false }}"
        show-progress="{{ true }}"
        show-casting-button="{{ false }}"
        show-snapshot-button="{{ false }}"
        show-screen-lock-button="{{ false }}"
        show-mute-btn="{{ false }}"
        show-background-playback-button="{{ false }}"
        enable-play-in-background="{{ false }}"
        enable-auto-rotation="{{ false }}"
        enable-danmu="{{ false }}"
        enable-play-gesture="{{ false }}"
        vslide-gesture="{{ false }}"
        vslide-gesture-in-fullscreen="{{ false }}"
        object-fit="cover"
        initial-time="{{ 0 }}"
        catch:tap="onVideoTap"
        bindplay="onVideoPlay"
        bindpause="onVideoPause"
        bindended="onVideoEnded"
        binderror="onVideoError"
        bindloadstart="onVideoLoadStart"
        bindcanplay="onVideoCanPlay"
        bindwaiting="onVideoWaiting"
        bindloadeddata="onVideoLoadedData"
        bindloadedmetadata="onVideoLoadedMetadata"
        bindtimeupdate="onVideoTimeUpdate"
      >
      </video>
    </view>

    <!-- Douyin-style video play button overlay -->
    <view
      wx:if="{{ showVideoPlayButton }}"
      class="video-play-button"
      catchtap="onVideoPlayButtonTap"
    >
      <image
        src="/images/play.png"
        class="play-button-image"
        mode="aspectFit"
      />
    </view>
  </view>

  <!-- Play/Pause overlay indicator for image posts only -->
  <view
    class="play-indicator {{ showPlayIndicator ? 'show' : '' }}"
    wx:if="{{ currentPost.type === 'image' }}"
  >
    <view class="play-icon-container">
      <view wx:if="{{ isPlaying }}" class="svg-icon pause-icon">
        <image
          src="/images/icons/pause.svg"
          class="svg-icon"
          mode="aspectFit"
        ></image>
      </view>
      <view wx:else class="svg-icon play-icon">
        <image
          src="/images/icons/play.svg"
          class="svg-icon"
          mode="aspectFit"
        ></image>
      </view>
    </view>
  </view>
</view>