<!-- components/media-player/media-player.wxml -->
<view class="media-player-container" 
      bindtouchstart="onTouchStart" 
      bindtouchend="onTouchEnd">
  
  <!-- Loading indicator -->
  <view wx:if="{{isLoading}}" class="loading-overlay">
    <view class="loading-spinner">
      <view class="spinner-ring"></view>
    </view>
    <text class="loading-text">Loading...</text>
  </view>

  <!-- Main media container (Full Screen) -->
  <view class="main-content" wx:if="{{!isLoading && selectedPost}}">
    
    <!-- Interactive dots for images (only when not paused) -->
    <view wx:if="{{!showDetail && selectedPost.type === 'image' && dots.length > 0}}" class="dots-container">
      <view wx:for="{{realDotsPosition}}" 
            wx:key="index"
            class="interactive-dot {{selectedDot && selectedDot.id === dots[index].id ? 'selected' : ''}}"
            style="top: {{item.top}}px; left: {{item.left}}px;"
            bindtap="onDotTap"
            data-index="{{index}}">
        
        <!-- Pulsing animations -->
        <view class="dot-ring-pulse"></view>
        <view class="dot-ring-rotate"></view>
        <view class="dot-shadow"></view>
        
        <!-- Main dot -->
        <view class="dot-main">
          <view class="dot-center"></view>
        </view>
        
        <!-- Highlight effect -->
        <view class="dot-highlight"></view>
      </view>
    </view>

    <!-- Media swiper -->
    <swiper class="media-swiper"
            current="{{currentSlideIndex}}"
            bindchange="onSlideChange"
            circular="{{false}}"
            indicator-dots="{{false}}"
            autoplay="{{false}}"
            duration="300">
      
      <swiper-item wx:for="{{selectedPost.media}}" wx:key="index">
        <view class="media-item">
          
          <!-- Image media -->
          <view wx:if="{{selectedPost.type === 'image'}}" class="image-container">
            <image id="media-image"
                   class="media-image"
                   src="{{item.url}}"
                   mode="aspectFit"
                   bindtap="onImagePreview"
                   bindload="calculateDotsPosition"
                   lazy-load="{{true}}" />
          </view>
          
          <!-- Video media -->
          <video wx:if="{{selectedPost.type === 'video'}}"
                 class="media-video"
                 src="{{item.url}}"
                 poster="{{item.preview_url}}"
                 controls="{{true}}"
                 autoplay="{{isPlaying && !showDetail}}"
                 loop="{{true}}"
                 show-play-btn="{{true}}"
                 bindplay="onVideoPlay"
                 bindpause="onVideoPause"
                 bindended="onVideoEnded" />
        </view>
      </swiper-item>
    </swiper>

    <!-- Media controls for images (only when detail panel is hidden) -->
    <view wx:if="{{selectedPost.type === 'image' && !showDetail}}" class="media-controls">
      <view class="progress-container">
        <!-- Progress indicators -->
        <view class="progress-indicators">
          <view wx:for="{{selectedPost.media}}" 
                wx:key="index"
                class="progress-dot {{currentSlideIndex >= index ? 'active' : ''}}"
                bindtap="onSlideChange"
                data-current="{{index}}">
          </view>
        </view>
        
        <!-- Control buttons -->
        <view class="control-buttons">
          <view class="play-pause-btn" bindtap="onPlayPause">
            <text class="control-icon">{{isPlaying ? 'â¸ï¸' : 'â–¶ï¸'}}</text>
          </view>
          
          <view class="continue-toggle">
            <switch class="continue-switch" 
                    checked="{{isContinue}}" 
                    bindchange="onContinueToggle" 
                    color="#ff4757" />
            <text class="continue-text">è¿æ’­</text>
          </view>
        </view>
      </view>
    </view>

    <!-- Title overlay (only when detail panel is hidden) -->
    <view wx:if="{{selectedPost.title && !showDetail}}" class="title-overlay">
      <text class="title-text">{{truncateTitle(selectedPost.title, 30)}}</text>
    </view>

    <!-- Action buttons (only when detail panel is hidden) -->
    <view wx:if="{{!showDetail}}" class="action-buttons">
      <!-- User avatar and follow -->
      <view class="user-action" bindtap="onUserProfile">
        <image class="user-avatar" 
               src="{{selectedPostUser.avatar || '/images/default-avatar.png'}}" 
               mode="aspectFill" />
        <view wx:if="{{selectedPostUser.id !== authUser.id && authUser && authUser.role === 'user'}}" 
              class="follow-btn {{selectedPostUser.is_followed ? 'following' : ''}}"
              bindtap="handleFollow"
              catchtap="true">
          <text class="follow-icon">{{selectedPostUser.is_followed ? 'â–' : 'â•'}}</text>
        </view>
      </view>

      <!-- Like button -->
      <view wx:if="{{authUser && authUser.role === 'user'}}" 
            class="action-item" 
            bindtap="handleLike">
        <text class="action-icon like-icon {{selectedPost.likes_exists ? 'liked' : ''}}">â¤ï¸</text>
        <text class="action-count">{{formatNumber(selectedPost.likes)}}</text>
      </view>

      <!-- Comment button -->
      <view class="action-item" bindtap="onToggleDetail">
        <text class="action-icon">ğŸ’¬</text>
        <text class="action-count">{{formatNumber(selectedPost.comments)}}</text>
      </view>

      <!-- Favorite button -->
      <view wx:if="{{authUser && authUser.role === 'user'}}" 
            class="action-item" 
            bindtap="handleFavorite">
        <text class="action-icon favorite-icon {{selectedPost.favorites_exists ? 'favorited' : ''}}">â­</text>
        <text class="action-count">{{formatNumber(selectedPost.favorites)}}</text>
      </view>

      <!-- Share button -->
      <view class="action-item" bindtap="handleShare">
        <text class="action-icon">ğŸ“¤</text>
        <text class="action-count">{{formatNumber(selectedPost.shares)}}</text>
      </view>

      <!-- Report button -->
      <view class="action-item" bindtap="onShowReportModal">
        <text class="action-icon">âš ï¸</text>
      </view>
    </view>

    <!-- Right edge swipe area indicator (only when detail panel is hidden) -->
    <view wx:if="{{!showDetail}}" class="right-edge-indicator">
      <view class="swipe-hint">
        <text class="hint-text">ğŸ‘ˆ</text>
        <text class="hint-label">æ»‘åŠ¨æŸ¥çœ‹</text>
      </view>
    </view>
  </view>

  <!-- Detail panel overlay (Full screen overlay when shown) -->
  <view wx:if="{{showDetail}}" class="detail-panel-overlay" bindtap="onCloseDetail">
    <view class="detail-panel" catchtap="stopPropagation">
      <!-- Close button -->
      <view class="close-btn" bindtap="onCloseDetail">
        <text class="close-icon">âœ–ï¸</text>
      </view>

      <!-- Tab navigation -->
      <view class="tab-navigation">
        <view class="tab-item {{tabIndex === 0 ? 'active' : ''}}" 
              bindtap="onTabChange" 
              data-index="0">
          <text class="tab-text">{{selectedPostUser.username}}çš„ä½œå“</text>
        </view>
        <view class="tab-item {{tabIndex === 1 ? 'active' : ''}}" 
              bindtap="onTabChange" 
              data-index="1">
          <text class="tab-text">è¯„è®º</text>
        </view>
        <view class="tab-item {{tabIndex === 2 ? 'active' : ''}}" 
              bindtap="onTabChange" 
              data-index="2">
          <text class="tab-text">è¯¦æƒ…</text>
        </view>
      </view>

      <!-- Tab content -->
      <view class="tab-content">
        
        <!-- User posts tab -->
        <scroll-view wx:if="{{tabIndex === 0}}" 
                     class="user-posts-tab" 
                     scroll-y="true">
          <!-- User info -->
          <view class="user-info">
            <view class="user-details">
              <text class="username">@{{selectedPostUser.username}}</text>
              <text class="user-stats">
                ç²‰ä¸: {{formatNumber(selectedPostUser.follower_number)}}, 
                è·èµ: {{formatNumber(selectedPostUser.like_number)}}
              </text>
            </view>
            <button wx:if="{{selectedPostUser.id !== authUser.id && authUser}}" 
                    class="follow-button {{selectedPostUser.is_followed ? 'following' : ''}}"
                    bindtap="handleFollow">
              <text>{{selectedPostUser.is_followed ? 'å–æ¶ˆå…³æ³¨' : 'å…³æ³¨'}}</text>
            </button>
          </view>

          <view class="divider"></view>

          <!-- Posts grid -->
          <view class="posts-grid">
            <view wx:for="{{selectedUserPosts.posts}}" 
                  wx:key="id"
                  class="post-item"
                  bindtap="onSelectPost"
                  data-post="{{item}}">
              <image class="post-thumbnail" 
                     src="{{item.type === 'video' ? item.media[0].preview_url : item.media[0].url}}" 
                     mode="aspectFill" />
              <view wx:if="{{item.type === 'video'}}" class="video-indicator">
                <text class="video-icon">â–¶ï¸</text>
              </view>
            </view>
          </view>
        </scroll-view>

        <!-- Comments tab -->
        <view wx:if="{{tabIndex === 1}}" class="comments-tab">
          <!-- Post info -->
          <view class="post-info">
            <view class="post-title">
              <text class="info-label">æ ‡é¢˜:</text>
              <text class="info-content">{{selectedPost.title}}</text>
            </view>
            <view wx:if="{{selectedPost.content}}" class="post-content">
              <text class="content-text">{{selectedPost.content}}</text>
            </view>
          </view>

          <view class="divider"></view>

          <!-- Comments list -->
          <scroll-view class="comments-list" scroll-y="true">
            <view wx:for="{{userComments}}" wx:key="id" class="comment-item">
              <!-- Comment content -->
              <view class="comment-header">
                <image class="comment-avatar" 
                       src="{{item.sender.avatar || '/images/default-avatar.png'}}" 
                       mode="aspectFill" />
                <view class="comment-info">
                  <text class="comment-username">{{item.sender.username}}</text>
                  <text class="comment-time">{{item.created_at}}</text>
                </view>
              </view>
              
              <view class="comment-content">
                <text wx:if="{{item.comment_text}}" class="comment-text">{{item.comment_text}}</text>
                <image wx:if="{{item.url}}" 
                       class="comment-image" 
                       src="{{item.url}}" 
                       mode="aspectFit"
                       bindtap="onImagePreview"
                       data-url="{{item.url}}" />
              </view>

              <!-- Comment actions -->
              <view class="comment-actions">
                <view class="action-group">
                  <view class="comment-action-btn" 
                        bindtap="onReplyComment" 
                        data-comment-id="{{item.id}}">
                    <text class="action-icon">ğŸ’¬</text>
                    <text class="action-text">å›å¤</text>
                  </view>
                  
                  <view wx:if="{{item.sender.id === authUser.id}}" 
                        class="comment-action-btn"
                        bindtap="onEditComment"
                        data-comment="{{item}}">
                    <text class="action-icon">âœï¸</text>
                    <text class="action-text">ç¼–è¾‘</text>
                  </view>
                  
                  <view wx:if="{{item.sender.id === authUser.id}}" 
                        class="comment-action-btn delete-btn"
                        bindtap="onDeleteComment"
                        data-comment-id="{{item.id}}">
                    <text class="action-icon">ğŸ—‘ï¸</text>
                    <text class="action-text">åˆ é™¤</text>
                  </view>
                </view>

                <view class="like-actions">
                  <view class="like-btn" 
                        bindtap="onLikeComment"
                        data-comment-id="{{item.id}}"
                        data-type="like">
                    <text class="like-icon">ğŸ‘</text>
                    <text class="like-count">{{item.like || 0}}</text>
                  </view>
                  <view class="like-btn" 
                        bindtap="onLikeComment"
                        data-comment-id="{{item.id}}"
                        data-type="unlike">
                    <text class="like-icon">ğŸ‘</text>
                    <text class="like-count">{{item.unlike || 0}}</text>
                  </view>
                </view>
              </view>
            </view>

            <!-- Empty state -->
            <view wx:if="{{userComments.length === 0}}" class="empty-comments">
              <text class="empty-text">æš‚æ— è¯„è®ºï¼Œå¿«æ¥æŠ¢æ²™å‘å§ï¼</text>
            </view>
          </scroll-view>

          <!-- Comment input -->
          <view wx:if="{{authUser && authUser.role === 'user'}}" class="comment-input">
            <!-- Reply indicator -->
            <view wx:if="{{commentId}}" class="reply-indicator">
              <text class="reply-text">{{isUpdate ? 'ç¼–è¾‘è¯„è®º' : 'å›å¤è¯„è®º'}}</text>
              <view class="cancel-reply" bindtap="onCancelReply">
                <text class="cancel-icon">âœ–ï¸</text>
              </view>
            </view>

            <!-- Input area -->
            <view class="input-container">
              <textarea class="comment-textarea"
                        placeholder="{{commentId ? (isUpdate ? 'ç¼–è¾‘ä½ çš„è¯„è®º...' : 'å†™ä¸‹ä½ çš„å›å¤...') : 'è¯´ç‚¹ä»€ä¹ˆ...'}}"
                        value="{{personalComment}}"
                        bindinput="onCommentInput"
                        maxlength="500"
                        auto-height="{{true}}"
                        cursor-spacing="10" />
              
              <view class="input-actions">
                <button class="submit-btn {{personalComment.trim() ? 'active' : ''}}" 
                        bindtap="onCommentSubmit"
                        disabled="{{!personalComment.trim()}}">
                  <text class="submit-text">{{isUpdate ? 'æ›´æ–°' : 'å‘é€'}}</text>
                </button>
              </view>
            </view>
          </view>

          <!-- Login prompt for non-logged users -->
          <view wx:if="{{!authUser}}" class="login-prompt">
            <text class="prompt-text">ç™»å½•åå¯å‘è¡¨è¯„è®º</text>
            <button class="login-btn" bindtap="onLoginPrompt">
              <text>ç™»å½•</text>
            </button>
          </view>
        </view>

        <!-- Details tab -->
        <view wx:if="{{tabIndex === 2}}" class="details-tab">
          <view class="details-container">
            <!-- Title section -->
            <view class="detail-section">
              <view class="section-header">
                <text class="section-title">æ ‡é¢˜</text>
              </view>
              <view class="section-content">
                <text wx:if="{{selectedDot}}" class="detail-text">{{selectedDot.title}}</text>
                <text wx:else class="placeholder-text">æœªé€‰æ‹©ä»»ä½•ç‚¹ã€‚è¯·ç‚¹å‡»å›¾ç‰‡ä¸Šçš„æ ‡è®°æŸ¥çœ‹è¯¦æƒ…ã€‚</text>
              </view>
            </view>

            <!-- Description section -->
            <view class="detail-section">
              <view class="section-header">
                <text class="section-title">è¯´æ˜</text>
              </view>
              <view class="section-content">
                <text wx:if="{{selectedDot}}" class="detail-text">{{selectedDot.description}}</text>
                <text wx:else class="placeholder-text">æœªé€‰æ‹©ä»»ä½•ì ã€‚è¯·ç‚¹å‡»å›¾ç‰‡ä¸Šì˜ æ ‡è®°æŸ¥çœ‹è¯¦æƒ…ã€‚</text>
              </view>
            </view>

            <!-- Additional info when dot is selected -->
            <view wx:if="{{selectedDot}}" class="selected-dot-info">
              <view class="dot-id">
                <text class="info-label">ç‚¹ ID:</text>
                <text class="info-value">{{selectedDot.id}}</text>
              </view>
            </view>
          </view>
        </view>
      </view>
    </view>
  </view>

  <!-- Report modal -->
  <view wx:if="{{showReportModal}}" class="modal-overlay" bindtap="onCloseReportModal">
    <view class="report-modal" catchtap="stopPropagation">
      <view class="modal-header">
        <text class="modal-title">ä¸¾æŠ¥å†…å®¹</text>
        <view class="modal-close" bindtap="onCloseReportModal">
          <text class="close-icon">âœ–ï¸</text>
        </view>
      </view>
      
      <view class="modal-content">
        <view class="report-options">
          <view class="report-option" bindtap="onReport" data-type="spam">
            <text class="option-text">åƒåœ¾ä¿¡æ¯</text>
          </view>
          <view class="report-option" bindtap="onReport" data-type="inappropriate">
            <text class="option-text">å†…å®¹ä¸å½“</text>
          </view>
          <view class="report-option" bindtap="onReport" data-type="harassment">
            <text class="option-text">éªšæ‰°ä»–äºº</text>
          </view>
          <view class="report-option" bindtap="onReport" data-type="fake">
            <text class="option-text">è™šå‡ä¿¡æ¯</text>
          </view>
          <view class="report-option" bindtap="onReport" data-type="other">
            <text class="option-text">å…¶ä»–åŸå› </text>
          </view>
        </view>
      </view>
    </view>
  </view>

  <!-- Empty state -->
  <view wx:if="{{!isLoading && !selectedPost}}" class="empty-state">
    <text class="empty-text">æ²¡æœ‰ä½œå“å¯å±•ç¤º</text>
  </view>

</view>