<app-layout current-page="me">
  <view class="me-container">
  <!-- User Profile Header -->
  <view class="profile-header">
    <view class="profile-info">
      <view class="avatar-container">
        <avatar class="avatar" avatar="{{userInfo.avatar}}" name="{{userInfo.username}}" size="120" mode="aspectFill" />
      </view>
      
      <view class="user-details">
        <view class="username-section">
          <text class="username">{{userInfo.username}}</text>
          <view class="user-meta">
            <text class="phone">(æ‰‹æœº: {{userInfo.phone}},</text>
            <view class="gender-age">
              <text class="gender-icon">{{userInfo.gender === 'male' ? 'â™‚' : 'â™€'}}</text>
            </view>
            )
          </view>
        </view>
        
        <view class="stats-container">
          <view class="stat-item">
            <text class="stat-number">{{userInfo.likes_count || 0}}</text>
            <text class="stat-label">è·èµ</text>
          </view>
          <view class="stat-item">
            <text class="stat-number">{{userInfo.friends_count || 0}}</text>
            <text class="stat-label">å¥½å‹</text>
          </view>
          <view class="stat-item">
            <text class="stat-number">{{userInfo.follows_count || 0}}</text>
            <text class="stat-label">å…³æ³¨</text>
          </view>
          <view class="stat-item">
            <text class="stat-number">{{userInfo.followers_count || 0}}</text>
            <text class="stat-label">ç²‰ä¸</text>
          </view>
        </view>
      </view>
    </view>
  </view>

  <!-- Tabs Navigation -->
  <view class="tabs-container">
    <view class="tabs">
      <view 
        wx:for="{{tabs}}" 
        wx:key="index"
        class="tab-item {{currentTab === index ? 'active' : ''}}"
        data-index="{{index}}"
        bindtap="onTabChange"
      >
        <text>{{item}}</text>
      </view>
    </view>
  </view>

  <!-- Posts Grid (for tabs 0-3) -->
  <view class="posts-container" wx:if="{{currentTab !== 4}}">
    <view wx:if="{{!loading && posts.length === 0}}" class="empty-state">
      <text class="empty-text">æš‚æ— å†…å®¹</text>
    </view>
    
    <view wx:else class="posts-grid">
      <view 
        wx:for="{{posts}}" 
        wx:key="id"
        class="post-card"
        data-id="{{item.id}}"
        bindtap="onPostTap"
      >
        <image class="post-image" src="{{item.type=='video'?item.media[0].preview_url:item.media[0].url}}" mode="aspectFill" />
        
        <view class="post-overlay">
          <view class="post-stats">
            <view class="stat">
              <text class="stat-icon">â™¥</text>
              <text class="stat-text">{{item.likes}}</text>
            </view>
            <view class="stat">
              <text class="stat-icon">ğŸ’¬</text>
              <text class="stat-text">{{item.comments}}</text>
            </view>
          </view>
        </view>
        
        <view wx:if="{{currentTab === 0}}" class="post-actions">
          <view 
            class="action-btn delete-btn"
            data-id="{{item.id}}"
            catchtap="onDeletePost"
          >
            <text>ğŸ—‘ï¸</text>
          </view>
        </view>
      </view>
    </view>

    <!-- Loading Indicator -->
    <view wx:if="{{loading}}" class="loading-container">
      <view class="loading-spinner"></view>
      <text class="loading-text">{{messages.loading}}</text>
    </view>
  </view>

  <!-- Profile Tab Content (tab 4) -->
  <view class="profile-tab-container" wx:if="{{currentTab === 4}}">
    <!-- Profile Header Actions -->
    <view class="profile-actions">
      <view class="left-actions">
        <button 
          class="profile-action-btn edit-btn" 
          bindtap="toggleProfileEdit"
          wx:if="{{!isEditingProfile}}"
        >
          <text class="btn-icon">âœï¸</text>
          <text class="btn-text">ç¼–è¾‘èµ„æ–™</text>
        </button>
        
        <view class="edit-actions" wx:if="{{isEditingProfile}}">
          <button class="profile-action-btn save-btn" bindtap="saveProfile">
            <text class="btn-icon">âœ…</text>
            <text class="btn-text">ä¿å­˜</text>
          </button>
          <button class="profile-action-btn cancel-btn" bindtap="cancelProfileEdit">
            <text class="btn-icon">âŒ</text>
            <text class="btn-text">å–æ¶ˆ</text>
          </button>
        </view>
      </view>
      
      <!-- Hide logout button when editing -->
      <button 
        class="profile-action-btn logout-btn" 
        bindtap="handleLogout"
        wx:if="{{!isEditingProfile}}"
      >
        <text class="btn-icon">ğŸšª</text>
        <text class="btn-text">é€€å‡ºç™»å½•</text>
      </button>
    </view>

    <!-- Avatar Section -->
    <view class="avatar-section">
      <view class="avatar-container-large" bindtap="selectAvatar">
        <avatar class="avatar-large" avatar="{{selectedAvatar || userInfo.avatar}}" name="{{userInfo.username}}" size="156" mode="aspectFill" />
        <view class="avatar-overlay" wx:if="{{isEditingProfile}}">
          <text class="avatar-edit-icon">ğŸ“·</text>
          <text class="avatar-edit-text">æ›´æ¢å¤´åƒ</text>
        </view>
      </view>
      <view class="avatar-info">
        <text class="avatar-name">{{userInfo.name || userInfo.username}}</text>
        <text class="avatar-university">{{university.name || 'æœªè®¾ç½®å¤§å­¦'}}</text>
      </view>
    </view>

    <!-- Profile Form -->
    <view class="profile-form">
      <!-- Basic Information -->
      <view class="form-section">
        <view class="section-title">åŸºæœ¬ä¿¡æ¯</view>
        
        <!-- Name -->
        <view class="form-field">
          <label class="field-label">å§“å</label>
          <input 
            class="field-input {{profileErrors.name ? 'error' : ''}}"
            value="{{profileForm.name}}"
            placeholder="è¯·è¾“å…¥å§“å"
            disabled="{{!isEditingProfile}}"
            data-field="name"
            bindinput="onProfileInputChange"
          />
          <text class="error-text" wx:if="{{profileErrors.name}}">{{profileErrors.name}}</text>
        </view>

        <!-- Phone -->
        <view class="form-field">
          <label class="field-label">
            æ‰‹æœºå·
            <view class="verification-status" wx:if="{{phoneChanged && !phoneVerified}}">
              <text class="status-text">éœ€è¦éªŒè¯</text>
            </view>
          </label>
          <view class="phone-input">
            <text class="phone-prefix">+86</text>
            <input 
              class="field-input phone-number {{profileErrors.phone ? 'error' : ''}}"
              value="{{profileForm.phone}}"
              placeholder="è¯·è¾“å…¥æ‰‹æœºå·"
              disabled="{{!isEditingProfile}}"
              data-field="phone"
              bindinput="onProfileInputChange"
            />
          </view>
          
          <!-- Phone Verification Section -->
          <view wx:if="{{phoneChanged && !phoneVerified && isEditingProfile}}" class="verification-section">
            <button class="send-code-btn" bindtap="sendPhoneVerificationCode">
              å‘é€éªŒè¯ç 
            </button>
            <view class="otp-input-container">
              <input 
                class="otp-input"
                placeholder="è¯·è¾“å…¥æ‰‹æœºéªŒè¯ç "
                value="{{phoneOtpCode}}"
                bindinput="onPhoneOtpInput"
              />
              <button class="verify-code-btn" bindtap="verifyPhoneCode">
                éªŒè¯
              </button>
            </view>
          </view>
          
          <text class="error-text" wx:if="{{profileErrors.phone}}">{{profileErrors.phone}}</text>
        </view>

        <!-- Email -->
        <view class="form-field">
          <label class="field-label">
            é‚®ç®±
            <view class="verification-status" wx:if="{{emailChanged && !emailVerified}}">
              <text class="status-text">éœ€è¦éªŒè¯</text>
            </view>
          </label>
          <input 
            class="field-input {{profileErrors.email ? 'error' : ''}}"
            value="{{profileForm.email}}"
            placeholder="è¯·è¾“å…¥é‚®ç®±"
            disabled="{{!isEditingProfile}}"
            data-field="email"
            bindinput="onProfileInputChange"
          />
          
          <!-- Email Verification Section -->
          <view wx:if="{{emailChanged && !emailVerified && isEditingProfile}}" class="verification-section">
            <button class="send-code-btn" bindtap="sendEmailVerificationCode">
              å‘é€éªŒè¯ç 
            </button>
            <view class="otp-input-container">
              <input 
                class="otp-input"
                placeholder="è¯·è¾“å…¥é‚®ç®±éªŒè¯ç "
                value="{{emailOtpCode}}"
                bindinput="onEmailOtpInput"
              />
              <button class="verify-code-btn" bindtap="verifyEmailCode">
                éªŒè¯
              </button>
            </view>
          </view>
          
          <text class="error-text" wx:if="{{profileErrors.email}}">{{profileErrors.email}}</text>
        </view>

        <!-- Gender -->
        <view class="form-field">
          <label class="field-label">æ€§åˆ«</label>
          <view class="gender-options">
            <view 
              class="gender-option {{profileForm.gender === 'male' ? 'selected' : ''}} {{!isEditingProfile ? 'disabled' : ''}}"
              data-gender="male"
              bindtap="{{isEditingProfile ? 'onGenderChange' : ''}}"
            >
              <text class="gender-icon">â™‚</text>
              <text class="gender-text">ç”·</text>
            </view>
            <view 
              class="gender-option {{profileForm.gender === 'female' ? 'selected' : ''}} {{!isEditingProfile ? 'disabled' : ''}}"
              data-gender="female"
              bindtap="{{isEditingProfile ? 'onGenderChange' : ''}}"
            >
              <text class="gender-icon">â™€</text>
              <text class="gender-text">å¥³</text>
            </view>
          </view>
          <text class="error-text" wx:if="{{profileErrors.gender}}">{{profileErrors.gender}}</text>
        </view>
      </view>

      <!-- Academic Information -->
      <view class="form-section">
        <view class="section-title">å­¦æœ¯ä¿¡æ¯</view>
        
        <!-- ID Number -->
        <view class="form-field">
          <label class="field-label">èº«ä»½è¯å·</label>
          <input 
            class="field-input {{profileErrors.id_number ? 'error' : ''}}"
            value="{{profileForm.id_number}}"
            placeholder="è¯·è¾“å…¥èº«ä»½è¯å·"
            disabled="{{!isEditingProfile}}"
            data-field="id_number"
            bindinput="onProfileInputChange"
          />
          <text class="error-text" wx:if="{{profileErrors.id_number}}">{{profileErrors.id_number}}</text>
        </view>

        <!-- Student Number -->
        <view class="form-field">
          <label class="field-label">å­¦å·</label>
          <input 
            class="field-input {{profileErrors.student_number ? 'error' : ''}}"
            value="{{profileForm.student_number}}"
            placeholder="è¯·è¾“å…¥å­¦å·"
            disabled="{{!isEditingProfile}}"
            data-field="student_number"
            bindinput="onProfileInputChange"
          />
          <text class="error-text" wx:if="{{profileErrors.student_number}}">{{profileErrors.student_number}}</text>
        </view>

        <!-- Faculty -->
        <view class="form-field">
          <label class="field-label">å­¦é™¢</label>
          <picker 
            mode="selector"
            range="{{faculties}}"
            range-key="name"
            disabled="{{!isEditingProfile}}"
            data-field="faculty"
            bindchange="onProfileInputChange"
          >
            <view class="picker-view {{profileErrors.faculty ? 'error' : ''}}">
              <text wx:if="{{profileForm.faculty}}">{{profileForm.faculty}}</text>
              <text wx:else class="placeholder">è¯·é€‰æ‹©å­¦é™¢</text>
            </view>
          </picker>
          <text class="error-text" wx:if="{{profileErrors.faculty}}">{{profileErrors.faculty}}</text>
        </view>

        <!-- Major -->
        <view class="form-field">
          <label class="field-label">ä¸“ä¸š</label>
          <picker 
            mode="selector"
            range="{{availableMajors}}"
            range-key="name"
            disabled="{{!isEditingProfile || !profileForm.faculty}}"
            data-field="major"
            bindchange="onProfileInputChange"
          >
            <view class="picker-view {{profileErrors.major ? 'error' : ''}}">
              <text wx:if="{{profileForm.major}}">{{profileForm.major}}</text>
              <text wx:else class="placeholder">è¯·é€‰æ‹©ä¸“ä¸š</text>
            </view>
          </picker>
          <text class="error-text" wx:if="{{profileErrors.major}}">{{profileErrors.major}}</text>
        </view>

        <!-- Class -->
        <view class="form-field">
          <label class="field-label">ç­çº§</label>
          <input 
            class="field-input {{profileErrors.class ? 'error' : ''}}"
            value="{{profileForm.class}}"
            placeholder="è¯·è¾“å…¥ç­çº§"
            disabled="{{!isEditingProfile}}"
            data-field="class"
            bindinput="onProfileInputChange"
          />
          <text class="error-text" wx:if="{{profileErrors.class}}">{{profileErrors.class}}</text>
        </view>

        <!-- Admission Year -->
        <view class="form-field">
          <label class="field-label">å…¥å­¦å¹´ä»½</label>
          <picker 
            mode="date"
            fields="year"
            value="{{profileForm.admissionYear}}"
            disabled="{{!isEditingProfile}}"
            data-field="admissionYear"
            bindchange="onProfileInputChange"
          >
            <view class="picker-view">
              <text>{{profileForm.admissionYear}}å¹´</text>
            </view>
          </picker>
        </view>
      </view>
    </view>
  </view>
  </view>
</app-layout>