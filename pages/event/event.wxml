<!--event.wxml-->
<view class="app-container">
  <!-- Navigation Header -->
  <view class="nav-header">
    <view class="nav-content">
      <view class="nav-brand">
        <view class="brand-icon">
          <view class="icon-dot"></view>
        </view>
        <text class="brand-text">活动展示</text>
      </view>
      <view class="nav-badge">
        <text class="badge-text">{{events.length}} 进行中</text>
      </view>
    </view>
  </view>

  <!-- Main Content -->
  <view class="main-container">
    <!-- Featured Event Section -->
    <view class="featured-section">
      <view class="section-header">
        <text class="section-title">推荐活动</text>
        <text class="section-subtitle">发现精彩机会</text>
      </view>

      <view class="featured-showcase">
        <!-- Main Event Display -->
        <view class="showcase-main">
          <swiper 
            class="event-swiper" 
            indicator-dots="false"
            circular="true"
            autoplay="false"
            current="{{currentEventIndex}}"
            bindchange="onSwiperChange">
            <swiper-item wx:for="{{events}}" wx:key="id">
              <view class="event-slide">
                <view class="slide-image-container">
                  <image class="slide-image" src="{{item.poster_image}}" mode="aspectFill"></image>
                  <view class="image-overlay"></view>
                </view>
                
                <view class="slide-content">
                  <view class="event-meta">
                    <view class="meta-item">
                      <view class="meta-icon calendar-icon"></view>
                      <text class="meta-text">{{item.start_date}} - {{item.end_date}}</text>
                    </view>
                    <view class="meta-item">
                      <view class="meta-icon location-icon"></view>
                      <text class="meta-text">{{item.user.university.name}}</text>
                    </view>
                  </view>
                  
                  <text class="event-title">{{item.title}}</text>
                  
                  <view class="event-stats">
                    <view class="stat-item">
                      <text class="stat-number" wx:if="{{item.allow_limit}}">{{item.students_count}}/{{item.limit}}</text>
                      <text class="stat-number" wx:else>{{item.students_count}}</text>
                      <text class="stat-label">参与者</text>
                    </view>
                    <view class="stat-divider"></view>
                    <view class="stat-item">
                      <text class="stat-number" wx:if="{{item.allow_limit}}">{{item.limit - item.students_count}}</text>
                      <text class="stat-number" wx:else>∞</text>
                      <text class="stat-label">剩余名额</text>
                    </view>
                  </view>
                  
                  <button class="cta-button" bindtap="onParticipate">
                    <text class="cta-text">查看详情</text>
                    <view class="cta-arrow"></view>
                  </button>
                </view>
              </view>
            </swiper-item>
          </swiper>
        </view>

        <!-- Event Navigation -->
        <view class="showcase-nav">
          <view class="nav-list">
            <view 
              wx:for="{{events}}" 
              wx:key="id" 
              class="nav-item {{currentEventIndex === index ? 'active' : ''}}"
              data-index="{{index}}"
              bindtap="onEventSelect">
              <view class="nav-item-image">
                <image class="item-image" src="{{item.poster_image}}" mode="aspectFill"></image>
              </view>
              <view class="nav-item-content">
                <text class="item-title">{{item.title}}</text>
                <text class="item-subtitle">{{item.user.university.name}}</text>
                <view class="item-indicator" wx:if="{{currentEventIndex === index}}"></view>
              </view>
            </view>
          </view>
        </view>
      </view>
    </view>

    <!-- Past Events Section -->
    <view class="past-section">
      <view class="section-header">
        <text class="section-title">往期活动</text>
        <text class="section-subtitle">{{pastEvents.length}} 个已完成活动</text>
      </view>
      
      <view wx:if="{{pastEvents.length > 0}}" class="past-grid">
        <view wx:for="{{pastEvents}}" wx:key="id" class="past-card">
          <view class="past-image-wrapper">
            <image class="past-image" src="{{item.poster_image}}" mode="aspectFill"></image>
            <view class="past-status">已结束</view>
          </view>
          <view class="past-info">
            <text class="past-title">{{item.title}}</text>
            <text class="past-university">{{item.user.university.name}}</text>
            <view class="past-stats">
              <text class="past-participants" wx:if="{{item.allow_limit}}">{{item.students_count}}/{{item.limit}} 参与者</text>
              <text class="past-participants" wx:else>{{item.students_count}} 参与者</text>
            </view>
          </view>
        </view>
      </view>
      
      <view wx:else class="empty-past">
        <view class="empty-icon"></view>
        <text class="empty-title">暂无往期活动</text>
        <text class="empty-description">已完成的活动将在这里显示</text>
      </view>
    </view>
  </view>

  <!-- Loading state -->
  <view wx:if="{{loading && !events.length}}" class="loading-container">
    <view class="loading-spinner"></view>
    <text class="loading-text">{{messages.loading}}</text>
  </view>

  <!-- Error state -->
  <view wx:elif="{{error}}" class="error-container">
    <icon type="warn" size="64" color="#E53E3E"></icon>
    <text class="error-text">{{error}}</text>
    <button class="retry-button" bindtap="fetchEvents">重试</button>
  </view>


  <!-- Event Rules Modal -->
  <view wx:if="{{showRulesModal}}" class="modal-backdrop" bindtap="onCloseRulesModal">
    <view class="modal-dialog" catchtap="">
      <view class="modal-content">
        <view class="modal-header">
          <text class="modal-title">活动指南</text>
          <button class="modal-close" bindtap="onCloseRulesModal">
            <view class="close-icon"></view>
          </button>
        </view>
        
        <view class="modal-body">
          <view class="event-preview">
            <image class="preview-image" src="{{selectedEvent.poster_image}}" mode="aspectFill"></image>
            <text class="preview-title">{{selectedEvent.title}}</text>
          </view>
          <view class="description-content">
            <text class="description-text">{{selectedEvent.description}}</text>
          </view>
        </view>
        
        <view class="modal-footer">
          <button class="modal-btn secondary" bindtap="onCloseRulesModal">{{messages.actions.close}}</button>
          <button class="modal-btn primary" bindtap="onAgreeRules">{{messages.actions.agree}}并继续</button>
        </view>
      </view>
    </view>
  </view>

  <!-- Filter Bar -->
  <filter-bar currentFilter="event"></filter-bar>

  <!-- Page content -->
  <view class="container">
    <!-- Show loading state -->
    <block wx:if="{{loading}}">
      <view class="loading-container">
        <view class="loading-spinner"></view>
        <text class="loading-text">{{messages.loading}}</text>
      </view>
    </block>
    
    <!-- Show error state -->
    <block wx:elif="{{error}}">
      <view class="error-container">
        <text class="error-text">{{error}}</text>
        <button class="retry-button" bindtap="fetchEvents">重试</button>
      </view>
    </block>
    
    <!-- Show empty state -->
    <block wx:elif="{{events.length === 0 && pastEvents.length === 0}}">
      <view class="empty-container">
        <text class="empty-text">暂无活动</text>
      </view>
    </block>
    
    <block wx:else>
      <!-- Event display content here -->
    </block>
  </view>

  <!-- Bottom Tab Bar -->
  <douyin-tabbar current="event"></douyin-tabbar>
</view>