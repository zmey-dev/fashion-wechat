<wxs src="../../utils/userDisplayName.wxs" module="userUtils" />
<app-layout current-page="index" search-params="{{searchParams}}" bind:search="onSearch">
  <!-- Main Content Area with Scroll View for infinite scroll -->
  <scroll-view 
    class="content-area" 
    id="contentArea"
    scroll-y="{{true}}"
    bindscrolltolower="onReachBottom"
    lower-threshold="80"
  >
    <!-- Posts Grid -->
    <view class="posts-grid">
      <view 
        wx:for="{{posts}}" 
        wx:key="id"
        class="post-card"
        data-post-id="{{item.id}}"
        data-index="{{index}}"
        bindtap="onPostTap"
      >
        <!-- Media Container -->
        <view class="media-container">
          <image 
            class="post-image"
            src="{{item.type === 'video' ? item.media[0].preview_url : item.media[0].url}}"
            lazy-load="{{true}}"
            mode="aspectFill"
          />
        </view>
        
        <!-- User Section -->
        <view class="user-section">
          <view class="user-info">
            <view class="user-row" catchtap="onUserTap" data-username="{{item.user.username}}" data-userId="{{item.user.id}}">
              <avatar avatar="{{item.user.avatar}}" user="{{item.user}}" size="45"></avatar>
              <text class="user-name">{{userUtils.getShortDisplayName(item.user, 8)}}</text>
            </view>
          </view>
          <view class="like-display">
            <image class="heart-icon" src="/images/icons/heart.svg" mode="aspectFit"></image>
            <text class="like-count">{{item.likes}}</text>
          </view>
        </view>
      </view>
    </view>
    
    <!-- Loading State for first load -->
    <view class="loading-container" wx:if="{{loading && posts.length === 0}}">
      <image class="loading-logo" src="/images/logo.png" mode="aspectFit"></image>
      <view class="loading-progress-bar">
        <view class="loading-progress-fill"></view>
      </view>
      <text class="loading-text">{{messages.loading}}</text>
    </view>
    
    <!-- Loading more indicator -->
    <view class="loading-more" wx:if="{{loading && posts.length > 0}}">
      <image class="loading-logo small" src="/images/logo.png" mode="aspectFit"></image>
      <view class="loading-progress-bar small">
        <view class="loading-progress-fill"></view>
      </view>
      <text class="loading-text">åŠ è½½æ›´å¤š...</text>
    </view>
    
    <!-- Empty State -->
    <view class="empty-state" wx:if="{{!loading && posts.length === 0}}">
      <text class="empty-icon">ğŸ”</text>
      <text class="empty-title">è¿˜æ²¡æœ‰å†…å®¹</text>
      <text class="empty-desc">ç¨åå†æ¥æŸ¥çœ‹ï¼Œæˆ–è€…å°è¯•å…¶ä»–åˆ†ç±»</text>
    </view>
    
    <!-- End Message -->
    <view class="end-message" wx:if="{{!hasMore && posts.length > 0}}">
      <text class="end-text">å·²ç»åˆ°åº•äº†</text>
    </view>
  </scroll-view>

  <!-- Scroll To Top Button -->
  <view 
    wx:if="{{showScrollTop}}" 
    class="scroll-top-button {{scrollTopAnimating ? 'animating' : ''}}" 
    bindtap="onScrollToTop"
  >
    <view class="scroll-top-inner">
      <view class="arrow-up"></view>
      <view class="arrow-up second"></view>
    </view>
    <view class="scroll-top-ripple"></view>
  </view>
    
  <!-- Login Modal -->
  <login-modal wx:if="{{showLoginModal}}" bind:close="onLoginClose" bind:success="onLoginSuccess" />
  
</app-layout>