<!-- Profile Page -->
<wxs src="../../utils/userDisplayName.wxs" module="userUtils" />
<app-layout current-page="profile">
  <!-- Main Loading Screen -->
  <view wx:if="{{isLoading}}" class="loading-container">
    <image class="loading-logo" src="/images/logo.png" mode="aspectFit"></image>
    <view class="loading-progress-bar">
      <view class="loading-progress-fill"></view>
    </view>
    <text class="loading-text">{{loadingMessage}}</text>
  </view>
  
  <view class="profile-container" wx:else><!-- Avatar Section - Horizontal Layout with Edit/Cancel Buttons -->
    <view class="avatar-section-horizontal">
      <view class="avatar-container-horizontal" bindtap="selectAvatar">
        <avatar class="avatar-medium" avatar="{{selectedAvatar || userInfo.avatar}}" user="{{userInfo}}" size="120" mode="aspectFill" />
        <view class="avatar-overlay" wx:if="{{isEditingProfile || userInfo.role === 'company'}}">
          <text class="avatar-edit-icon">ğŸ“·</text>
        </view>
      </view>
      <view class="user-info-horizontal">
        <text class="user-name-horizontal">{{userUtils.getDisplayName(userInfo)}}</text>
        <text class="user-id-horizontal">ID: {{userInfo.username}}</text>
        <text wx:if="{{userInfo.role !== 'company'}}" class="user-university-horizontal">{{university.name || 'æœªè®¾ç½®å¤§å­¦'}}</text>
      </view>
      
      <!-- Edit/Cancel Buttons (Hidden for company users) -->
      <view class="avatar-right-buttons" wx:if="{{userInfo.role !== 'company'}}">
        <!-- Edit Mode: Show Save and Cancel buttons -->
        <view class="action-buttons-container" wx:if="{{isEditingProfile}}">
          <view class="action-button save-button" bindtap="saveProfile">
            <text class="button-icon">âœ“</text>
            <text class="button-label">ä¿å­˜</text>
          </view>
          <view class="action-button cancel-button" bindtap="cancelProfileEdit">
            <text class="button-icon">âœ•</text>
            <text class="button-label">å–æ¶ˆ</text>
          </view>
        </view>
        
        <!-- View Mode: Show Edit button only -->
        <view class="action-buttons-container" wx:else>
          <view class="action-button edit-button" bindtap="toggleProfileEdit">
            <image class="image-icon" src="/images/icons/edit.svg"></image>
            <text class="button-label">ç¼–è¾‘</text>
          </view>
        </view>
      </view>
    </view>

    <!-- Profile Form -->
    <view class="profile-form">
      <!-- Company Profile (Read-only except avatar and username) -->
      <view wx:if="{{userInfo.role === 'company'}}" class="company-profile-container">
        <!-- Company Header Card -->
        <view class="company-header-card">
          <view class="company-logo-section">
            <view class="company-logo-placeholder">
              <text class="logo-icon">ğŸ¢</text>
            </view>
            <view class="company-basic-info">
              <text class="company-title">{{userInfo.company_name || 'ä¼ä¸šåç§°'}}</text>
              <text class="company-subtitle">{{userInfo.legal_representative || 'æ³•å®šä»£è¡¨äºº'}}</text>
              <view class="company-status-badge">
                <text class="status-text">å·²è®¤è¯ä¼ä¸š</text>
              </view>
            </view>
          </view>
        </view>

        <!-- Username Section - Enhanced -->
        <view class="form-section company-username-section">
          <view class="section-title-enhanced">
            <text class="section-icon">ğŸ‘¤</text>
            <text class="section-text">ç”¨æˆ·ä¿¡æ¯</text>
          </view>
          
          <view class="form-field-enhanced" id="company-username-field">
            <view class="field-header">
              <label class="field-label-enhanced">ç”¨æˆ·ID</label>
              <text wx:if="{{!userInfo.is_id_changed}}" class="edit-hint-enhanced">(ä»…èƒ½ä¿®æ”¹ä¸€æ¬¡)</text>
              <text wx:else class="changed-hint-enhanced">(å·²ä¿®æ”¹)</text>
            </view>
            <view class="input-wrapper-enhanced">
              <!-- View mode for company when editing is allowed -->
              <view wx:if="{{!isEditingUsername && !userInfo.is_id_changed}}" class="username-display-enhanced">
                <text class="username-text-enhanced">{{userInfo.username || 'æœªè®¾ç½®'}}</text>
                <view class="username-edit-btn-enhanced" bindtap="startEditUsername">
                  <text class="edit-btn-icon">âœï¸</text>
                  <text class="edit-btn-text">ç¼–è¾‘</text>
                </view>
              </view>
              <!-- View mode for company when editing is not allowed (already changed) -->
              <view wx:elif="{{!isEditingUsername && userInfo.is_id_changed}}" class="username-display-readonly-enhanced">
                <text class="username-text-readonly-enhanced">{{userInfo.username || 'æœªè®¾ç½®'}}</text>
                <text class="readonly-hint-enhanced">âœ… å·²ä¿®æ”¹ï¼Œä¸å¯å†æ¬¡æ›´æ”¹</text>
              </view>
              <!-- Edit mode -->
              <view wx:else class="username-edit-container-enhanced">
                <input 
                  class="field-input-enhanced {{usernameError ? 'error' : ''}}"
                  value="{{tempUsername}}"
                  placeholder="è¾“å…¥ç”¨æˆ·ID (ä»…é™è‹±æ–‡)"
                  bindinput="onUsernameInput"
                  maxlength="30"
                />
                <view class="username-actions-enhanced">
                  <view class="username-action-btn-enhanced save-btn" bindtap="submitUsernameChange">
                    <text class="btn-icon">âœ…</text>
                    <text>ä¿å­˜</text>
                  </view>
                  <view class="username-action-btn-enhanced cancel-btn" bindtap="cancelUsernameEdit">
                    <text class="btn-icon">âŒ</text>
                    <text>å–æ¶ˆ</text>
                  </view>
                </view>
              </view>
            </view>
            <text class="error-text" wx:if="{{usernameError}}">{{usernameError}}</text>
            <text class="hint-text-enhanced" wx:if="{{!userInfo.is_id_changed}}">ğŸ’¡ åªèƒ½ä½¿ç”¨è‹±æ–‡å­—æ¯ã€æ•°å­—ã€ä¸‹åˆ’çº¿(_)ã€è¿å­—ç¬¦(-)å’Œç‚¹(.)</text>
          </view>
        </view>

        <!-- Company Details Section -->
        <view class="form-section company-details-section">
          <view class="section-title-enhanced">
            <text class="section-icon">ğŸ›ï¸</text>
            <text class="section-text">ä¼ä¸šè¯¦æƒ…</text>
          </view>

          <view class="company-info-grid">
            <!-- Company Name -->
            <view class="company-info-card">
              <view class="info-card-header">
                <text class="info-icon">ğŸ¢</text>
                <text class="info-label">ä¼ä¸šåç§°</text>
              </view>
              <text class="info-value">{{userInfo.company_name || 'æœªè®¾ç½®'}}</text>
            </view>

            <!-- Legal Representative -->
            <view class="company-info-card" wx:if="{{userInfo.legal_representative}}">
              <view class="info-card-header">
                <text class="info-icon">ğŸ‘¤</text>
                <text class="info-label">æ³•å®šä»£è¡¨äºº</text>
              </view>
              <text class="info-value">{{userInfo.legal_representative}}</text>
            </view>

            <!-- Phone -->
            <view class="company-info-card">
              <view class="info-card-header">
                <text class="info-icon">ğŸ“</text>
                <text class="info-label">è”ç³»ç”µè¯</text>
              </view>
              <text class="info-value">{{userInfo.phone || 'æœªè®¾ç½®'}}</text>
            </view>

            <!-- Email -->
            <view class="company-info-card">
              <view class="info-card-header">
                <text class="info-icon">ğŸ“§</text>
                <text class="info-label">ä¼ä¸šé‚®ç®±</text>
              </view>
              <text class="info-value">{{userInfo.email || 'æœªè®¾ç½®'}}</text>
            </view>
          </view>

          <!-- Address Section -->
          <view class="company-address-section" wx:if="{{userInfo.address}}">
            <view class="address-header">
              <text class="address-icon">ğŸ“</text>
              <text class="address-label">ä¼ä¸šåœ°å€</text>
            </view>
            <view class="address-content">
              <text class="address-text">{{userInfo.address}}</text>
            </view>
          </view>

          <!-- Description Section -->
          <view class="company-description-section" wx:if="{{userInfo.description}}">
            <view class="description-header">
              <text class="description-icon">ğŸ“</text>
              <text class="description-label">ä¼ä¸šæè¿°</text>
            </view>
            <view class="description-content">
              <text class="description-text">{{userInfo.description}}</text>
            </view>
          </view>
        </view>

        <!-- Legal Information Section -->
        <view class="form-section company-legal-section" wx:if="{{userInfo.unified_credit_code || userInfo.created_at}}">
          <view class="section-title-enhanced">
            <text class="section-icon">ğŸ“‹</text>
            <text class="section-text">æ³•å¾‹ä¿¡æ¯</text>
          </view>

          <view class="legal-info-container">
            <!-- Credit Code -->
            <view class="legal-info-item" wx:if="{{userInfo.unified_credit_code}}">
              <view class="legal-item-header">
                <text class="legal-icon">ğŸ”¢</text>
                <text class="legal-label">ç»Ÿä¸€ç¤¾ä¼šä¿¡ç”¨ä»£ç </text>
              </view>
              <view class="credit-code-display">
                <text class="credit-code-text">{{userInfo.unified_credit_code}}</text>
                <view class="verification-badge">
                  <text class="verify-icon">âœ…</text>
                  <text class="verify-text">å·²éªŒè¯</text>
                </view>
              </view>
            </view>

            <!-- Registration Date -->
            <view class="legal-info-item" wx:if="{{userInfo.created_at}}">
              <view class="legal-item-header">
                <text class="legal-icon">ğŸ“…</text>
                <text class="legal-label">æ³¨å†Œæ—¶é—´</text>
              </view>
              <text class="legal-value">{{userInfo.created_at}}</text>
            </view>
          </view>
        </view>

        <!-- Company Stats/Highlights -->
        <view class="company-stats-section">
          <view class="section-title-enhanced">
            <text class="section-icon">ğŸ“Š</text>
            <text class="section-text">ä¼ä¸šæ¦‚è§ˆ</text>
          </view>
          
          <view class="stats-grid">
            <view class="stat-card">
              <text class="stat-icon">ğŸ¯</text>
              <text class="stat-label">ä¼ä¸šç±»å‹</text>
              <text class="stat-value">è®¤è¯ä¼ä¸š</text>
            </view>
            <view class="stat-card">
              <text class="stat-icon">â­</text>
              <text class="stat-label">è®¤è¯çŠ¶æ€</text>
              <text class="stat-value">å·²è®¤è¯</text>
            </view>
            <view class="stat-card">
              <text class="stat-icon">ğŸ”</text>
              <text class="stat-label">è´¦æˆ·å®‰å…¨</text>
              <text class="stat-value">é«˜çº§</text>
            </view>
          </view>
        </view>
        
        <!-- Password Change Section for Company -->
        <view class="form-section">
          <view class="section-title">å¯†ç ç®¡ç†</view>
          
          <view class="form-field">
            <label class="field-label">å½“å‰å¯†ç </label>
            <view class="input-wrapper">
              <input 
                class="field-input {{passwordErrors.old_password ? 'error' : ''}}"
                password="{{true}}"
                value="{{passwordForm.old_password}}"
                placeholder="è¯·è¾“å…¥å½“å‰å¯†ç "
                data-field="old_password"
                bindinput="onPasswordInputChange"
              />
            </view>
            <text class="error-text" wx:if="{{passwordErrors.old_password}}">{{passwordErrors.old_password}}</text>
          </view>

          <view class="form-field">
            <label class="field-label">æ–°å¯†ç </label>
            <view class="input-wrapper">
              <input 
                class="field-input {{passwordErrors.new_password ? 'error' : ''}}"
                password="{{true}}"
                value="{{passwordForm.new_password}}"
                placeholder="è¯·è¾“å…¥æ–°å¯†ç  (6-20ä½)"
                data-field="new_password"
                bindinput="onPasswordInputChange"
              />
            </view>
            <text class="error-text" wx:if="{{passwordErrors.new_password}}">{{passwordErrors.new_password}}</text>
          </view>

          <view class="form-field">
            <label class="field-label">ç¡®è®¤æ–°å¯†ç </label>
            <view class="input-wrapper">
              <input 
                class="field-input {{passwordErrors.new_password_confirmation ? 'error' : ''}}"
                password="{{true}}"
                value="{{passwordForm.new_password_confirmation}}"
                placeholder="è¯·å†æ¬¡è¾“å…¥æ–°å¯†ç "
                data-field="new_password_confirmation"
                bindinput="onPasswordInputChange"
              />
            </view>
            <text class="error-text" wx:if="{{passwordErrors.new_password_confirmation}}">{{passwordErrors.new_password_confirmation}}</text>
          </view>

          <!-- Change Password Button -->
          <view class="password-actions">
            <view class="action-button change-password-btn" bindtap="changePassword">
              <text class="button-label" wx:if="{{!passwordChanging}}">ä¿®æ”¹å¯†ç </text>
              <text class="button-label" wx:else>ä¿®æ”¹ä¸­...</text>
            </view>
          </view>

          <!-- Success/Error Messages -->
          <view wx:if="{{passwordMessage}}" class="success-message">
            <text>{{passwordMessage}}</text>
          </view>
          <view wx:if="{{passwordError}}" class="error-message">
            <text>{{passwordError}}</text>
          </view>
        </view>

        <!-- WeChat Linking Section for Company -->
        <view class="form-section">
          <view class="section-title">å¾®ä¿¡ç»‘å®š</view>
          
          <view class="form-field">
            <label class="field-label">å¾®ä¿¡è´¦å·</label>
            <view class="wechat-status-container">
              <view class="wechat-status-row">
                <view class="wechat-status {{isWechatLinked ? 'linked' : 'unlinked'}}">
                  <view class="wechat-status-icon">
                    <text wx:if="{{isWechatLinked}}">âœ…</text>
                    <text wx:else>âŒ</text>
                  </view>
                  <view class="wechat-status-text">
                    <text wx:if="{{isWechatLinked}}">å·²ç»‘å®šå¾®ä¿¡</text>
                    <text wx:else>æœªç»‘å®šå¾®ä¿¡</text>
                  </view>
                </view>
                
                <!-- WeChat Action Button moved next to status -->
                <view class="wechat-actions-inline">
                  <view 
                    wx:if="{{!isWechatLinked}}"
                    class="action-button wechat-link-btn link-btn"
                    bindtap="linkWechat"
                  >
                    <text class="button-label" wx:if="{{!wechatLinking}}">ç»‘å®š</text>
                    <text class="button-label" wx:else>ç»‘å®šä¸­</text>
                  </view>
                  
                  <view 
                    wx:if="{{isWechatLinked}}"
                    class="action-button wechat-link-btn unlink-btn"
                    bindtap="unlinkWechat"
                  >
                    <text class="button-label" wx:if="{{!wechatLinking}}">è§£é™¤</text>
                    <text class="button-label" wx:else>å¤„ç†ä¸­</text>
                  </view>
                </view>
              </view>
            </view>
            
            <view class="wechat-description">
              <text wx:if="{{!isWechatLinked}}">ç»‘å®šå¾®ä¿¡åå¯ä½¿ç”¨å¾®ä¿¡å¿«æ·ç™»å½•</text>
              <text wx:else>æ‚¨å¯ä»¥ä½¿ç”¨å¾®ä¿¡ç™»å½•æˆ–è§£é™¤ç»‘å®š</text>
            </view>
          </view>
          
          <!-- Logout Button moved here -->
          <view class="form-field logout-section">
            <view class="logout-button-container">
              <view class="action-button logout-button" bindtap="handleLogout">
                <image class="image-icon" src="/images/icons/logout.svg"></image>
                <text class="button-label">é€€å‡ºç™»å½•</text>
              </view>
            </view>
          </view>
        </view>
      </view>

      <!-- Student/Teacher Profile (Original form for non-company users) -->
      <view wx:elif="{{userInfo.role !== 'company'}}" class="form-section">
        <view class="section-title">åŸºæœ¬ä¿¡æ¯</view>
          <!-- Name -->
        <view class="form-field" id="name-field">
          <label class="field-label">å§“å</label>
          <view class="input-wrapper">
            <input 
              class="field-input {{profileErrors.name ? 'error' : ''}}"
              value="{{profileForm.name}}"
              placeholder="è¯·è¾“å…¥å§“å"
              disabled="{{!isEditingProfile}}"
              data-field="name"
              bindinput="onProfileInputChange"
            />
          </view>
          <text class="error-text" wx:if="{{profileErrors.name}}">{{profileErrors.name}}</text>
        </view>

        <!-- Nickname -->
        <view class="form-field" id="nickname-field">
          <label class="field-label">æ˜µç§°</label>
          <view class="input-wrapper">
            <input 
              class="field-input {{profileErrors.nickname ? 'error' : ''}}"
              value="{{profileForm.nickname}}"
              placeholder="è¯·è¾“å…¥æ˜µç§°"
              disabled="{{!isEditingProfile}}"
              data-field="nickname"
              bindinput="onProfileInputChange"
            />
          </view>
          <text class="error-text" wx:if="{{profileErrors.nickname}}">{{profileErrors.nickname}}</text>
        </view>

        <!-- Username/User ID -->
        <view class="form-field" id="username-field" wx:if="{{userInfo.is_id_changed === false}}">
          <label class="field-label">ç”¨æˆ·ID (ä»…èƒ½ä¿®æ”¹ä¸€æ¬¡)</label>
          <view class="input-wrapper">
            <!-- View mode -->
            <view wx:if="{{!isEditingUsername}}" class="username-display">
              <text class="username-text">{{userInfo.username}}</text>
              <view class="username-edit-btn" bindtap="startEditUsername">
                <text class="edit-btn-text">ç¼–è¾‘</text>
              </view>
            </view>
            <!-- Edit mode -->
            <view wx:else class="username-edit-container">
              <input 
                class="field-input {{usernameError ? 'error' : ''}}"
                value="{{tempUsername}}"
                placeholder="è¾“å…¥ç”¨æˆ·ID (ä»…é™è‹±æ–‡)"
                bindinput="onUsernameInput"
                maxlength="30"
              />
              <view class="username-actions">
                <view class="username-action-btn save-btn" bindtap="submitUsernameChange">
                  <text>ä¿å­˜</text>
                </view>
                <view class="username-action-btn cancel-btn" bindtap="cancelUsernameEdit">
                  <text>å–æ¶ˆ</text>
                </view>
              </view>
            </view>
          </view>
          <text class="error-text" wx:if="{{usernameError}}">{{usernameError}}</text>
          <text class="hint-text">åªèƒ½ä½¿ç”¨è‹±æ–‡å­—æ¯ã€æ•°å­—ã€ä¸‹åˆ’çº¿(_)ã€è¿å­—ç¬¦(-)å’Œç‚¹(.)</text>
        </view>

        <!-- Phone -->
        <view class="form-field" id="phone-field">
          <label class="field-label">
            æ‰‹æœºå·
            <view class="verification-status" wx:if="{{phoneChanged && !phoneVerified}}">
              <text class="status-text">éœ€è¦éªŒè¯</text>
            </view>
          </label>
          <view class="input-wrapper">
            <view class="phone-input">
              <text class="phone-prefix">+86</text>
              <input 
                class="field-input phone-number {{profileErrors.phone ? 'error' : ''}}"
                value="{{profileForm.phone}}"
                placeholder="è¯·è¾“å…¥æ‰‹æœºå·"
                disabled="{{!isEditingProfile}}"
                data-field="phone"
                bindinput="onProfileInputChange"
              />
            </view>
          </view>
          
          <!-- Phone Verification Section -->
          <view wx:if="{{phoneChanged && !phoneVerified && isEditingProfile}}" class="verification-section">
            <view class="profile-action-btn send-code-btn {{phoneCountdown > 0 ? 'disabled' : ''}}" bindtap="sendPhoneVerificationCode">
              <text class="btn-text">{{phoneCountdown > 0 ? phoneCountdown + 'ç§’åé‡è¯•' : 'å‘é€éªŒè¯ç '}}</text>
            </view>
            <view class="otp-input-container">
              <view class="input-wrapper">
                <input 
                  class="otp-input"
                  placeholder="è¯·è¾“å…¥æ‰‹æœºéªŒè¯ç "
                  value="{{phoneOtpCode}}"
                  bindinput="onPhoneOtpInput"
                />
              </view>
              <view class="profile-action-btn verify-code-btn" bindtap="verifyPhoneCode">
                <text class="btn-text">éªŒè¯</text>
              </view>
            </view>
            
            <!-- Phone Verification Messages -->
            <view wx:if="{{phoneVerificationMessage}}" class="success-message">
              <text>{{phoneVerificationMessage}}</text>
            </view>
            <view wx:if="{{phoneVerificationError}}" class="error-message">
              <text>{{phoneVerificationError}}</text>
            </view>
          </view>
          
          <text class="error-text" wx:if="{{profileErrors.phone}}">{{profileErrors.phone}}</text>
        </view>        <!-- Email -->
        <view class="form-field" id="email-field">
          <label class="field-label">
            é‚®ç®±
            <view class="verification-status" wx:if="{{emailChanged && !emailVerified}}">
              <text class="status-text">éœ€è¦éªŒè¯</text>
            </view>
          </label>
          <view class="input-wrapper">
            <input 
              class="field-input {{profileErrors.email ? 'error' : ''}}"
              value="{{profileForm.email}}"
              placeholder="è¯·è¾“å…¥é‚®ç®±"
              disabled="{{!isEditingProfile}}"
              data-field="email"
              bindinput="onProfileInputChange"
            />
          </view>
          
          <!-- Email Verification Section -->
          <view wx:if="{{emailChanged && !emailVerified && isEditingProfile}}" class="verification-section">
            <view class="profile-action-btn send-code-btn {{emailCountdown > 0 ? 'disabled' : ''}}" bindtap="sendEmailVerificationCode">
              <text class="btn-text">{{emailCountdown > 0 ? emailCountdown + 'ç§’åé‡è¯•' : 'ë°œì†¡ ì½”ë“œ'}}</text>
            </view>
            <view class="otp-input-container">
              <view class="input-wrapper">
                <input 
                  class="otp-input"
                  placeholder="è¯·è¾“å…¥é‚®ç®±éªŒè¯ç "
                  value="{{emailOtpCode}}"
                  bindinput="onEmailOtpInput"
                />
              </view>
              <view class="profile-action-btn verify-code-btn" bindtap="verifyEmailCode">
                <text class="btn-text">éªŒè¯</text>
              </view>
            </view>
            
            <!-- Email Verification Messages -->
            <view wx:if="{{emailVerificationMessage}}" class="success-message">
              <text>{{emailVerificationMessage}}</text>
            </view>
            <view wx:if="{{emailVerificationError}}" class="error-message">
              <text>{{emailVerificationError}}</text>
            </view>
          </view>
          
          <text class="error-text" wx:if="{{profileErrors.email}}">{{profileErrors.email}}</text>
        </view>

        <!-- Gender -->
        <view class="form-field" id="gender-field">
          <label class="field-label">æ€§åˆ«</label>
          <view class="gender-options">
            <view 
              class="gender-option {{profileForm.gender === 'male' ? 'selected' : ''}} {{!isEditingProfile ? 'disabled' : ''}}"
              data-gender="male"
              bindtap="{{isEditingProfile ? 'onGenderChange' : ''}}"
            >
              <text class="gender-icon">â™‚</text>
              <text class="gender-text">ç”·</text>
            </view>
            <view 
              class="gender-option {{profileForm.gender === 'female' ? 'selected' : ''}} {{!isEditingProfile ? 'disabled' : ''}}"
              data-gender="female"
              bindtap="{{isEditingProfile ? 'onGenderChange' : ''}}"
            >
              <text class="gender-icon">â™€</text>
              <text class="gender-text">å¥³</text>
            </view>
          </view>
          <text class="error-text" wx:if="{{profileErrors.gender}}">{{profileErrors.gender}}</text>
        </view>

        <!-- Academic Information for non-company users only -->
        <view class="section-title">å­¦æœ¯ä¿¡æ¯</view>
          <!-- ID Number -->
        <view class="form-field" id="id-number-field">
          <label class="field-label">èº«ä»½è¯å·</label>
          <view class="input-wrapper">
            <input 
              class="field-input {{profileErrors.id_number ? 'error' : ''}}"
              value="{{profileForm.id_number}}"
              placeholder="è¯·è¾“å…¥èº«ä»½è¯å·"
              disabled="{{!isEditingProfile}}"
              data-field="id_number"
              bindinput="onProfileInputChange"
            />
          </view>
          <text class="error-text" wx:if="{{profileErrors.id_number}}">{{profileErrors.id_number}}</text>
        </view>

        <!-- Student Number -->
        <view class="form-field" id="student-number-field">
          <label class="field-label">å­¦å·</label>
          <view class="input-wrapper">
            <input 
              class="field-input {{profileErrors.student_number ? 'error' : ''}}"
              value="{{profileForm.student_number}}"
              placeholder="è¯·è¾“å…¥å­¦å·"
              disabled="{{!isEditingProfile}}"
              data-field="student_number"
              bindinput="onProfileInputChange"
            />
          </view>
          <text class="error-text" wx:if="{{profileErrors.student_number}}">{{profileErrors.student_number}}</text>
        </view>

        <!-- Faculty -->
        <view class="form-field" id="faculty-field">
          <label class="field-label">å­¦é™¢</label>
          <picker 
            mode="selector"
            range="{{faculties}}"
            range-key="name"
            value="{{facultyIndex}}"
            disabled="{{!isEditingProfile}}"
            data-field="faculty"
            bindchange="onProfileInputChange"
          >
            <view class="picker-view {{profileErrors.faculty ? 'error' : ''}}">
              <text wx:if="{{profileForm.faculty}}">{{profileForm.faculty}}</text>
              <text wx:else class="placeholder">è¯·é€‰æ‹©å­¦é™¢</text>
            </view>
          </picker>
          <text class="error-text" wx:if="{{profileErrors.faculty}}">{{profileErrors.faculty}}</text>
        </view>

        <!-- Major -->
        <view class="form-field" id="major-field">
          <label class="field-label">ä¸“ä¸š</label>
          <picker 
            mode="selector"
            range="{{availableMajors}}"
            range-key="name"
            value="{{majorIndex}}"
            disabled="{{!isEditingProfile || !profileForm.faculty}}"
            data-field="major"
            bindchange="onProfileInputChange"
          >
            <view class="picker-view {{profileErrors.major ? 'error' : ''}}">
              <text wx:if="{{profileForm.major}}">{{profileForm.major}}</text>
              <text wx:else class="placeholder">è¯·é€‰æ‹©ä¸“ä¸š</text>
            </view>
          </picker>
          <text class="error-text" wx:if="{{profileErrors.major}}">{{profileErrors.major}}</text>
        </view>        <!-- Class -->
        <view class="form-field" id="class-field">
          <label class="field-label">ç­çº§</label>
          <view class="input-wrapper">
            <input 
              class="field-input {{profileErrors.class ? 'error' : ''}}"
              value="{{profileForm.class}}"
              placeholder="è¯·è¾“å…¥ç­çº§"
              disabled="{{!isEditingProfile}}"
              data-field="class"
              bindinput="onProfileInputChange"
            />
          </view>
          <text class="error-text" wx:if="{{profileErrors.class}}">{{profileErrors.class}}</text>
        </view>

        <!-- Admission Year -->
        <view class="form-field" id="admission-year-field">
          <label class="field-label">å…¥å­¦å¹´ä»½</label>
          <picker 
            mode="date"
            fields="year"
            value="{{profileForm.admissionYear}}"
            disabled="{{!isEditingProfile}}"
            data-field="admissionYear"
            bindchange="onProfileInputChange"
          >
            <view class="picker-view {{profileErrors.admissionYear ? 'error' : ''}}">
              <text>{{profileForm.admissionYear}}å¹´</text>
            </view>
          </picker>
          <text class="error-text" wx:if="{{profileErrors.admissionYear}}">{{profileErrors.admissionYear}}</text>
        </view>

        <!-- Birthday -->
        <view class="form-field" id="birthday-field">
          <label class="field-label">ç”Ÿæ—¥</label>
          <picker 
            mode="date"
            value="{{profileForm.birthday}}"
            disabled="{{!isEditingProfile}}"
            data-field="birthday"
            bindchange="onProfileInputChange"
          >
            <view class="picker-view {{profileErrors.birthday ? 'error' : ''}}">
              <text wx:if="{{profileForm.birthday}}">{{profileForm.birthday}}</text>
              <text wx:else class="placeholder">è¯·é€‰æ‹©ç”Ÿæ—¥</text>
            </view>
          </picker>
          <text class="error-text" wx:if="{{profileErrors.birthday}}">{{profileErrors.birthday}}</text>
        </view>
      </view>
      
      <!-- Password Change Section for non-company users -->
      <view wx:if="{{userInfo.role !== 'company'}}" class="form-section">
        <view class="section-title">å¯†ç ç®¡ç†</view>
        
        <view class="form-field">
          <label class="field-label">å½“å‰å¯†ç </label>
          <view class="input-wrapper">
            <input 
              class="field-input {{passwordErrors.old_password ? 'error' : ''}}"
              password="{{true}}"
              value="{{passwordForm.old_password}}"
              placeholder="è¯·è¾“å…¥å½“å‰å¯†ç "
              data-field="old_password"
              bindinput="onPasswordInputChange"
            />
          </view>
          <text class="error-text" wx:if="{{passwordErrors.old_password}}">{{passwordErrors.old_password}}</text>
        </view>

        <view class="form-field">
          <label class="field-label">æ–°å¯†ç </label>
          <view class="input-wrapper">
            <input 
              class="field-input {{passwordErrors.new_password ? 'error' : ''}}"
              password="{{true}}"
              value="{{passwordForm.new_password}}"
              placeholder="è¯·è¾“å…¥æ–°å¯†ç  (6-20ä½)"
              data-field="new_password"
              bindinput="onPasswordInputChange"
            />
          </view>
          <text class="error-text" wx:if="{{passwordErrors.new_password}}">{{passwordErrors.new_password}}</text>
        </view>

        <view class="form-field">
          <label class="field-label">ç¡®è®¤æ–°å¯†ç </label>
          <view class="input-wrapper">
            <input 
              class="field-input {{passwordErrors.new_password_confirmation ? 'error' : ''}}"
              password="{{true}}"
              value="{{passwordForm.new_password_confirmation}}"
              placeholder="è¯·å†æ¬¡è¾“å…¥æ–°å¯†ç "
              data-field="new_password_confirmation"
              bindinput="onPasswordInputChange"
            />
          </view>
          <text class="error-text" wx:if="{{passwordErrors.new_password_confirmation}}">{{passwordErrors.new_password_confirmation}}</text>
        </view>

        <!-- Change Password Button -->
        <view class="password-actions">
          <view class="action-button change-password-btn" bindtap="changePassword">
            <text class="button-label" wx:if="{{!passwordChanging}}">ä¿®æ”¹å¯†ç </text>
            <text class="button-label" wx:else>ä¿®æ”¹ä¸­...</text>
          </view>
        </view>

        <!-- Success/Error Messages -->
        <view wx:if="{{passwordMessage}}" class="success-message">
          <text>{{passwordMessage}}</text>
        </view>
        <view wx:if="{{passwordError}}" class="error-message">
          <text>{{passwordError}}</text>
        </view>
      </view>

      <!-- WeChat Linking Section for non-company users -->
      <view wx:if="{{userInfo.role !== 'company'}}" class="form-section">
        <view class="section-title">å¾®ä¿¡ç»‘å®š</view>
        
        <view class="form-field">
          <label class="field-label">å¾®ä¿¡è´¦å·</label>
          <view class="wechat-status-container">
            <view class="wechat-status-row">
              <view class="wechat-status {{isWechatLinked ? 'linked' : 'unlinked'}}">
                <view class="wechat-status-icon">
                  <text wx:if="{{isWechatLinked}}">âœ…</text>
                  <text wx:else>âŒ</text>
                </view>
                <view class="wechat-status-text">
                  <text wx:if="{{isWechatLinked}}">å·²ç»‘å®šå¾®ä¿¡</text>
                  <text wx:else>æœªç»‘å®šå¾®ä¿¡</text>
                </view>
              </view>
              
              <!-- WeChat Action Button moved next to status -->
              <view class="wechat-actions-inline">
                <view 
                  wx:if="{{!isWechatLinked}}"
                  class="action-button wechat-link-btn link-btn"
                  bindtap="linkWechat"
                >
                  <text class="button-label" wx:if="{{!wechatLinking}}">ç»‘å®š</text>
                  <text class="button-label" wx:else>ç»‘å®šä¸­</text>
                </view>
                
                <view 
                  wx:if="{{isWechatLinked}}"
                  class="action-button wechat-link-btn unlink-btn"
                  bindtap="unlinkWechat"
                >
                  <text class="button-label" wx:if="{{!wechatLinking}}">è§£é™¤</text>
                  <text class="button-label" wx:else>å¤„ç†ä¸­</text>
                </view>
              </view>
            </view>
          </view>
          
          <view class="wechat-description">
            <text wx:if="{{!isWechatLinked}}">ç»‘å®šå¾®ä¿¡åå¯ä½¿ç”¨å¾®ä¿¡å¿«æ·ç™»å½•</text>
            <text wx:else>æ‚¨å¯ä»¥ä½¿ç”¨å¾®ä¿¡ç™»å½•æˆ–è§£é™¤ç»‘å®š</text>
          </view>
        </view>
        
        <!-- Logout Button moved here -->
        <view class="form-field logout-section">
          <view class="logout-button-container">
            <view class="action-button logout-button" bindtap="handleLogout">
              <image class="image-icon" src="/images/icons/logout.svg"></image>
              <text class="button-label">é€€å‡ºç™»å½•</text>
            </view>
          </view>
        </view>
      </view>
    </view>
  </view>
</app-layout>
