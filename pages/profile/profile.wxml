<!-- Profile Page -->
<wxs src="../../utils/userDisplayName.wxs" module="userUtils" />
<app-layout current-page="profile">
  <!-- Main Loading Screen -->
  <view wx:if="{{isLoading}}" class="loading-container">
    <image class="loading-logo" src="/images/logo.png" mode="aspectFit"></image>
    <view class="loading-progress-bar">
      <view class="loading-progress-fill"></view>
    </view>
    <text class="loading-text">{{loadingMessage}}</text>
  </view>
  
  <view class="profile-container" wx:else><!-- Avatar Section - Horizontal Layout with Edit/Cancel Buttons -->
    <view class="avatar-section-horizontal">
      <view class="avatar-container-horizontal" bindtap="selectAvatar">
        <avatar class="avatar-medium" avatar="{{selectedAvatar || userInfo.avatar}}" user="{{userInfo}}" size="120" mode="aspectFill" />
        <view class="avatar-overlay" wx:if="{{isEditingProfile || userInfo.role === 'company'}}">
          <text class="avatar-edit-icon">📷</text>
        </view>
      </view>
      <view class="user-info-horizontal">
        <text class="user-name-horizontal">{{userUtils.getDisplayName(userInfo)}}</text>
        <text class="user-id-horizontal">ID: {{userInfo.username}}</text>
        <text wx:if="{{userInfo.role !== 'company'}}" class="user-university-horizontal">{{university.name || '未设置大学'}}</text>
      </view>
      
      <!-- Edit/Cancel Buttons (Hidden for company users) -->
      <view class="avatar-right-buttons" wx:if="{{userInfo.role !== 'company'}}">
        <!-- Edit Mode: Show Save and Cancel buttons -->
        <view class="action-buttons-container" wx:if="{{isEditingProfile}}">
          <view class="action-button save-button" bindtap="saveProfile">
            <text class="button-icon">✓</text>
            <text class="button-label">保存</text>
          </view>
          <view class="action-button cancel-button" bindtap="cancelProfileEdit">
            <text class="button-icon">✕</text>
            <text class="button-label">取消</text>
          </view>
        </view>
        
        <!-- View Mode: Show Edit button only -->
        <view class="action-buttons-container" wx:else>
          <view class="action-button edit-button" bindtap="toggleProfileEdit">
            <image class="image-icon" src="/images/icons/edit.svg"></image>
            <text class="button-label">编辑</text>
          </view>
        </view>
      </view>
    </view>

    <!-- Profile Form -->
    <view class="profile-form">
      <!-- Company Profile (Read-only except avatar and username) -->
      <view wx:if="{{userInfo.role === 'company'}}" class="company-profile-container">
        <!-- Company Header Card -->
        <view class="company-header-card">
          <view class="company-logo-section">
            <view class="company-logo-placeholder">
              <text class="logo-icon">🏢</text>
            </view>
            <view class="company-basic-info">
              <text class="company-title">{{userInfo.company_name || '企业名称'}}</text>
              <text class="company-subtitle">{{userInfo.legal_representative || '法定代表人'}}</text>
              <view class="company-status-badge">
                <text class="status-text">已认证企业</text>
              </view>
            </view>
          </view>
        </view>

        <!-- Username Section - Enhanced -->
        <view class="form-section company-username-section">
          <view class="section-title-enhanced">
            <text class="section-icon">👤</text>
            <text class="section-text">用户信息</text>
          </view>
          
          <view class="form-field-enhanced" id="company-username-field">
            <view class="field-header">
              <label class="field-label-enhanced">用户ID</label>
              <text wx:if="{{!userInfo.is_id_changed}}" class="edit-hint-enhanced">(仅能修改一次)</text>
              <text wx:else class="changed-hint-enhanced">(已修改)</text>
            </view>
            <view class="input-wrapper-enhanced">
              <!-- View mode for company when editing is allowed -->
              <view wx:if="{{!isEditingUsername && !userInfo.is_id_changed}}" class="username-display-enhanced">
                <text class="username-text-enhanced">{{userInfo.username || '未设置'}}</text>
                <view class="username-edit-btn-enhanced" bindtap="startEditUsername">
                  <text class="edit-btn-icon">✏️</text>
                  <text class="edit-btn-text">编辑</text>
                </view>
              </view>
              <!-- View mode for company when editing is not allowed (already changed) -->
              <view wx:elif="{{!isEditingUsername && userInfo.is_id_changed}}" class="username-display-readonly-enhanced">
                <text class="username-text-readonly-enhanced">{{userInfo.username || '未设置'}}</text>
                <text class="readonly-hint-enhanced">✅ 已修改，不可再次更改</text>
              </view>
              <!-- Edit mode -->
              <view wx:else class="username-edit-container-enhanced">
                <input 
                  class="field-input-enhanced {{usernameError ? 'error' : ''}}"
                  value="{{tempUsername}}"
                  placeholder="输入用户ID (仅限英文)"
                  bindinput="onUsernameInput"
                  maxlength="30"
                />
                <view class="username-actions-enhanced">
                  <view class="username-action-btn-enhanced save-btn" bindtap="submitUsernameChange">
                    <text class="btn-icon">✅</text>
                    <text>保存</text>
                  </view>
                  <view class="username-action-btn-enhanced cancel-btn" bindtap="cancelUsernameEdit">
                    <text class="btn-icon">❌</text>
                    <text>取消</text>
                  </view>
                </view>
              </view>
            </view>
            <text class="error-text" wx:if="{{usernameError}}">{{usernameError}}</text>
            <text class="hint-text-enhanced" wx:if="{{!userInfo.is_id_changed}}">💡 只能使用英文字母、数字、下划线(_)、连字符(-)和点(.)</text>
          </view>
        </view>

        <!-- Company Details Section -->
        <view class="form-section company-details-section">
          <view class="section-title-enhanced">
            <text class="section-icon">🏛️</text>
            <text class="section-text">企业详情</text>
          </view>

          <view class="company-info-grid">
            <!-- Company Name -->
            <view class="company-info-card">
              <view class="info-card-header">
                <text class="info-icon">🏢</text>
                <text class="info-label">企业名称</text>
              </view>
              <text class="info-value">{{userInfo.company_name || '未设置'}}</text>
            </view>

            <!-- Legal Representative -->
            <view class="company-info-card" wx:if="{{userInfo.legal_representative}}">
              <view class="info-card-header">
                <text class="info-icon">👤</text>
                <text class="info-label">法定代表人</text>
              </view>
              <text class="info-value">{{userInfo.legal_representative}}</text>
            </view>

            <!-- Phone -->
            <view class="company-info-card">
              <view class="info-card-header">
                <text class="info-icon">📞</text>
                <text class="info-label">联系电话</text>
              </view>
              <text class="info-value">{{userInfo.phone || '未设置'}}</text>
            </view>

            <!-- Email -->
            <view class="company-info-card">
              <view class="info-card-header">
                <text class="info-icon">📧</text>
                <text class="info-label">企业邮箱</text>
              </view>
              <text class="info-value">{{userInfo.email || '未设置'}}</text>
            </view>
          </view>

          <!-- Address Section -->
          <view class="company-address-section" wx:if="{{userInfo.address}}">
            <view class="address-header">
              <text class="address-icon">📍</text>
              <text class="address-label">企业地址</text>
            </view>
            <view class="address-content">
              <text class="address-text">{{userInfo.address}}</text>
            </view>
          </view>

          <!-- Description Section -->
          <view class="company-description-section" wx:if="{{userInfo.description}}">
            <view class="description-header">
              <text class="description-icon">📝</text>
              <text class="description-label">企业描述</text>
            </view>
            <view class="description-content">
              <text class="description-text">{{userInfo.description}}</text>
            </view>
          </view>
        </view>

        <!-- Legal Information Section -->
        <view class="form-section company-legal-section" wx:if="{{userInfo.unified_credit_code || userInfo.created_at}}">
          <view class="section-title-enhanced">
            <text class="section-icon">📋</text>
            <text class="section-text">法律信息</text>
          </view>

          <view class="legal-info-container">
            <!-- Credit Code -->
            <view class="legal-info-item" wx:if="{{userInfo.unified_credit_code}}">
              <view class="legal-item-header">
                <text class="legal-icon">🔢</text>
                <text class="legal-label">统一社会信用代码</text>
              </view>
              <view class="credit-code-display">
                <text class="credit-code-text">{{userInfo.unified_credit_code}}</text>
                <view class="verification-badge">
                  <text class="verify-icon">✅</text>
                  <text class="verify-text">已验证</text>
                </view>
              </view>
            </view>

            <!-- Registration Date -->
            <view class="legal-info-item" wx:if="{{userInfo.created_at}}">
              <view class="legal-item-header">
                <text class="legal-icon">📅</text>
                <text class="legal-label">注册时间</text>
              </view>
              <text class="legal-value">{{userInfo.created_at}}</text>
            </view>
          </view>
        </view>

        <!-- Company Stats/Highlights -->
        <view class="company-stats-section">
          <view class="section-title-enhanced">
            <text class="section-icon">📊</text>
            <text class="section-text">企业概览</text>
          </view>
          
          <view class="stats-grid">
            <view class="stat-card">
              <text class="stat-icon">🎯</text>
              <text class="stat-label">企业类型</text>
              <text class="stat-value">认证企业</text>
            </view>
            <view class="stat-card">
              <text class="stat-icon">⭐</text>
              <text class="stat-label">认证状态</text>
              <text class="stat-value">已认证</text>
            </view>
            <view class="stat-card">
              <text class="stat-icon">🔐</text>
              <text class="stat-label">账户安全</text>
              <text class="stat-value">高级</text>
            </view>
          </view>
        </view>
        
        <!-- Password Change Section for Company -->
        <view class="form-section">
          <view class="section-title">密码管理</view>
          
          <view class="form-field">
            <label class="field-label">当前密码</label>
            <view class="input-wrapper">
              <input 
                class="field-input {{passwordErrors.old_password ? 'error' : ''}}"
                password="{{true}}"
                value="{{passwordForm.old_password}}"
                placeholder="请输入当前密码"
                data-field="old_password"
                bindinput="onPasswordInputChange"
              />
            </view>
            <text class="error-text" wx:if="{{passwordErrors.old_password}}">{{passwordErrors.old_password}}</text>
          </view>

          <view class="form-field">
            <label class="field-label">新密码</label>
            <view class="input-wrapper">
              <input 
                class="field-input {{passwordErrors.new_password ? 'error' : ''}}"
                password="{{true}}"
                value="{{passwordForm.new_password}}"
                placeholder="请输入新密码 (6-20位)"
                data-field="new_password"
                bindinput="onPasswordInputChange"
              />
            </view>
            <text class="error-text" wx:if="{{passwordErrors.new_password}}">{{passwordErrors.new_password}}</text>
          </view>

          <view class="form-field">
            <label class="field-label">确认新密码</label>
            <view class="input-wrapper">
              <input 
                class="field-input {{passwordErrors.new_password_confirmation ? 'error' : ''}}"
                password="{{true}}"
                value="{{passwordForm.new_password_confirmation}}"
                placeholder="请再次输入新密码"
                data-field="new_password_confirmation"
                bindinput="onPasswordInputChange"
              />
            </view>
            <text class="error-text" wx:if="{{passwordErrors.new_password_confirmation}}">{{passwordErrors.new_password_confirmation}}</text>
          </view>

          <!-- Change Password Button -->
          <view class="password-actions">
            <view class="action-button change-password-btn" bindtap="changePassword">
              <text class="button-label" wx:if="{{!passwordChanging}}">修改密码</text>
              <text class="button-label" wx:else>修改中...</text>
            </view>
          </view>

          <!-- Success/Error Messages -->
          <view wx:if="{{passwordMessage}}" class="success-message">
            <text>{{passwordMessage}}</text>
          </view>
          <view wx:if="{{passwordError}}" class="error-message">
            <text>{{passwordError}}</text>
          </view>
        </view>

        <!-- WeChat Linking Section for Company -->
        <view class="form-section">
          <view class="section-title">微信绑定</view>
          
          <view class="form-field">
            <label class="field-label">微信账号</label>
            <view class="wechat-status-container">
              <view class="wechat-status-row">
                <view class="wechat-status {{isWechatLinked ? 'linked' : 'unlinked'}}">
                  <view class="wechat-status-icon">
                    <text wx:if="{{isWechatLinked}}">✅</text>
                    <text wx:else>❌</text>
                  </view>
                  <view class="wechat-status-text">
                    <text wx:if="{{isWechatLinked}}">已绑定微信</text>
                    <text wx:else>未绑定微信</text>
                  </view>
                </view>
                
                <!-- WeChat Action Button moved next to status -->
                <view class="wechat-actions-inline">
                  <view 
                    wx:if="{{!isWechatLinked}}"
                    class="action-button wechat-link-btn link-btn"
                    bindtap="linkWechat"
                  >
                    <text class="button-label" wx:if="{{!wechatLinking}}">绑定</text>
                    <text class="button-label" wx:else>绑定中</text>
                  </view>
                  
                  <view 
                    wx:if="{{isWechatLinked}}"
                    class="action-button wechat-link-btn unlink-btn"
                    bindtap="unlinkWechat"
                  >
                    <text class="button-label" wx:if="{{!wechatLinking}}">解除</text>
                    <text class="button-label" wx:else>处理中</text>
                  </view>
                </view>
              </view>
            </view>
            
            <view class="wechat-description">
              <text wx:if="{{!isWechatLinked}}">绑定微信后可使用微信快捷登录</text>
              <text wx:else>您可以使用微信登录或解除绑定</text>
            </view>
          </view>
          
          <!-- Logout Button moved here -->
          <view class="form-field logout-section">
            <view class="logout-button-container">
              <view class="action-button logout-button" bindtap="handleLogout">
                <image class="image-icon" src="/images/icons/logout.svg"></image>
                <text class="button-label">退出登录</text>
              </view>
            </view>
          </view>
        </view>
      </view>

      <!-- Student/Teacher Profile (Original form for non-company users) -->
      <view wx:elif="{{userInfo.role !== 'company'}}" class="form-section">
        <view class="section-title">基本信息</view>
          <!-- Name -->
        <view class="form-field" id="name-field">
          <label class="field-label">姓名</label>
          <view class="input-wrapper">
            <input 
              class="field-input {{profileErrors.name ? 'error' : ''}}"
              value="{{profileForm.name}}"
              placeholder="请输入姓名"
              disabled="{{!isEditingProfile}}"
              data-field="name"
              bindinput="onProfileInputChange"
            />
          </view>
          <text class="error-text" wx:if="{{profileErrors.name}}">{{profileErrors.name}}</text>
        </view>

        <!-- Nickname -->
        <view class="form-field" id="nickname-field">
          <label class="field-label">昵称</label>
          <view class="input-wrapper">
            <input 
              class="field-input {{profileErrors.nickname ? 'error' : ''}}"
              value="{{profileForm.nickname}}"
              placeholder="请输入昵称"
              disabled="{{!isEditingProfile}}"
              data-field="nickname"
              bindinput="onProfileInputChange"
            />
          </view>
          <text class="error-text" wx:if="{{profileErrors.nickname}}">{{profileErrors.nickname}}</text>
        </view>

        <!-- Username/User ID -->
        <view class="form-field" id="username-field" wx:if="{{userInfo.is_id_changed === false}}">
          <label class="field-label">用户ID (仅能修改一次)</label>
          <view class="input-wrapper">
            <!-- View mode -->
            <view wx:if="{{!isEditingUsername}}" class="username-display">
              <text class="username-text">{{userInfo.username}}</text>
              <view class="username-edit-btn" bindtap="startEditUsername">
                <text class="edit-btn-text">编辑</text>
              </view>
            </view>
            <!-- Edit mode -->
            <view wx:else class="username-edit-container">
              <input 
                class="field-input {{usernameError ? 'error' : ''}}"
                value="{{tempUsername}}"
                placeholder="输入用户ID (仅限英文)"
                bindinput="onUsernameInput"
                maxlength="30"
              />
              <view class="username-actions">
                <view class="username-action-btn save-btn" bindtap="submitUsernameChange">
                  <text>保存</text>
                </view>
                <view class="username-action-btn cancel-btn" bindtap="cancelUsernameEdit">
                  <text>取消</text>
                </view>
              </view>
            </view>
          </view>
          <text class="error-text" wx:if="{{usernameError}}">{{usernameError}}</text>
          <text class="hint-text">只能使用英文字母、数字、下划线(_)、连字符(-)和点(.)</text>
        </view>

        <!-- Phone -->
        <view class="form-field" id="phone-field">
          <label class="field-label">
            手机号
            <view class="verification-status" wx:if="{{phoneChanged && !phoneVerified}}">
              <text class="status-text">需要验证</text>
            </view>
          </label>
          <view class="input-wrapper">
            <view class="phone-input">
              <text class="phone-prefix">+86</text>
              <input 
                class="field-input phone-number {{profileErrors.phone ? 'error' : ''}}"
                value="{{profileForm.phone}}"
                placeholder="请输入手机号"
                disabled="{{!isEditingProfile}}"
                data-field="phone"
                bindinput="onProfileInputChange"
              />
            </view>
          </view>
          
          <!-- Phone Verification Section -->
          <view wx:if="{{phoneChanged && !phoneVerified && isEditingProfile}}" class="verification-section">
            <view class="profile-action-btn send-code-btn {{phoneCountdown > 0 ? 'disabled' : ''}}" bindtap="sendPhoneVerificationCode">
              <text class="btn-text">{{phoneCountdown > 0 ? phoneCountdown + '秒后重试' : '发送验证码'}}</text>
            </view>
            <view class="otp-input-container">
              <view class="input-wrapper">
                <input 
                  class="otp-input"
                  placeholder="请输入手机验证码"
                  value="{{phoneOtpCode}}"
                  bindinput="onPhoneOtpInput"
                />
              </view>
              <view class="profile-action-btn verify-code-btn" bindtap="verifyPhoneCode">
                <text class="btn-text">验证</text>
              </view>
            </view>
            
            <!-- Phone Verification Messages -->
            <view wx:if="{{phoneVerificationMessage}}" class="success-message">
              <text>{{phoneVerificationMessage}}</text>
            </view>
            <view wx:if="{{phoneVerificationError}}" class="error-message">
              <text>{{phoneVerificationError}}</text>
            </view>
          </view>
          
          <text class="error-text" wx:if="{{profileErrors.phone}}">{{profileErrors.phone}}</text>
        </view>        <!-- Email -->
        <view class="form-field" id="email-field">
          <label class="field-label">
            邮箱
            <view class="verification-status" wx:if="{{emailChanged && !emailVerified}}">
              <text class="status-text">需要验证</text>
            </view>
          </label>
          <view class="input-wrapper">
            <input 
              class="field-input {{profileErrors.email ? 'error' : ''}}"
              value="{{profileForm.email}}"
              placeholder="请输入邮箱"
              disabled="{{!isEditingProfile}}"
              data-field="email"
              bindinput="onProfileInputChange"
            />
          </view>
          
          <!-- Email Verification Section -->
          <view wx:if="{{emailChanged && !emailVerified && isEditingProfile}}" class="verification-section">
            <view class="profile-action-btn send-code-btn {{emailCountdown > 0 ? 'disabled' : ''}}" bindtap="sendEmailVerificationCode">
              <text class="btn-text">{{emailCountdown > 0 ? emailCountdown + '秒后重试' : '발송 코드'}}</text>
            </view>
            <view class="otp-input-container">
              <view class="input-wrapper">
                <input 
                  class="otp-input"
                  placeholder="请输入邮箱验证码"
                  value="{{emailOtpCode}}"
                  bindinput="onEmailOtpInput"
                />
              </view>
              <view class="profile-action-btn verify-code-btn" bindtap="verifyEmailCode">
                <text class="btn-text">验证</text>
              </view>
            </view>
            
            <!-- Email Verification Messages -->
            <view wx:if="{{emailVerificationMessage}}" class="success-message">
              <text>{{emailVerificationMessage}}</text>
            </view>
            <view wx:if="{{emailVerificationError}}" class="error-message">
              <text>{{emailVerificationError}}</text>
            </view>
          </view>
          
          <text class="error-text" wx:if="{{profileErrors.email}}">{{profileErrors.email}}</text>
        </view>

        <!-- Gender -->
        <view class="form-field" id="gender-field">
          <label class="field-label">性别</label>
          <view class="gender-options">
            <view 
              class="gender-option {{profileForm.gender === 'male' ? 'selected' : ''}} {{!isEditingProfile ? 'disabled' : ''}}"
              data-gender="male"
              bindtap="{{isEditingProfile ? 'onGenderChange' : ''}}"
            >
              <text class="gender-icon">♂</text>
              <text class="gender-text">男</text>
            </view>
            <view 
              class="gender-option {{profileForm.gender === 'female' ? 'selected' : ''}} {{!isEditingProfile ? 'disabled' : ''}}"
              data-gender="female"
              bindtap="{{isEditingProfile ? 'onGenderChange' : ''}}"
            >
              <text class="gender-icon">♀</text>
              <text class="gender-text">女</text>
            </view>
          </view>
          <text class="error-text" wx:if="{{profileErrors.gender}}">{{profileErrors.gender}}</text>
        </view>

        <!-- Academic Information for non-company users only -->
        <view class="section-title">学术信息</view>
          <!-- ID Number -->
        <view class="form-field" id="id-number-field">
          <label class="field-label">身份证号</label>
          <view class="input-wrapper">
            <input 
              class="field-input {{profileErrors.id_number ? 'error' : ''}}"
              value="{{profileForm.id_number}}"
              placeholder="请输入身份证号"
              disabled="{{!isEditingProfile}}"
              data-field="id_number"
              bindinput="onProfileInputChange"
            />
          </view>
          <text class="error-text" wx:if="{{profileErrors.id_number}}">{{profileErrors.id_number}}</text>
        </view>

        <!-- Student Number -->
        <view class="form-field" id="student-number-field">
          <label class="field-label">学号</label>
          <view class="input-wrapper">
            <input 
              class="field-input {{profileErrors.student_number ? 'error' : ''}}"
              value="{{profileForm.student_number}}"
              placeholder="请输入学号"
              disabled="{{!isEditingProfile}}"
              data-field="student_number"
              bindinput="onProfileInputChange"
            />
          </view>
          <text class="error-text" wx:if="{{profileErrors.student_number}}">{{profileErrors.student_number}}</text>
        </view>

        <!-- Faculty -->
        <view class="form-field" id="faculty-field">
          <label class="field-label">学院</label>
          <picker 
            mode="selector"
            range="{{faculties}}"
            range-key="name"
            value="{{facultyIndex}}"
            disabled="{{!isEditingProfile}}"
            data-field="faculty"
            bindchange="onProfileInputChange"
          >
            <view class="picker-view {{profileErrors.faculty ? 'error' : ''}}">
              <text wx:if="{{profileForm.faculty}}">{{profileForm.faculty}}</text>
              <text wx:else class="placeholder">请选择学院</text>
            </view>
          </picker>
          <text class="error-text" wx:if="{{profileErrors.faculty}}">{{profileErrors.faculty}}</text>
        </view>

        <!-- Major -->
        <view class="form-field" id="major-field">
          <label class="field-label">专业</label>
          <picker 
            mode="selector"
            range="{{availableMajors}}"
            range-key="name"
            value="{{majorIndex}}"
            disabled="{{!isEditingProfile || !profileForm.faculty}}"
            data-field="major"
            bindchange="onProfileInputChange"
          >
            <view class="picker-view {{profileErrors.major ? 'error' : ''}}">
              <text wx:if="{{profileForm.major}}">{{profileForm.major}}</text>
              <text wx:else class="placeholder">请选择专业</text>
            </view>
          </picker>
          <text class="error-text" wx:if="{{profileErrors.major}}">{{profileErrors.major}}</text>
        </view>        <!-- Class -->
        <view class="form-field" id="class-field">
          <label class="field-label">班级</label>
          <view class="input-wrapper">
            <input 
              class="field-input {{profileErrors.class ? 'error' : ''}}"
              value="{{profileForm.class}}"
              placeholder="请输入班级"
              disabled="{{!isEditingProfile}}"
              data-field="class"
              bindinput="onProfileInputChange"
            />
          </view>
          <text class="error-text" wx:if="{{profileErrors.class}}">{{profileErrors.class}}</text>
        </view>

        <!-- Admission Year -->
        <view class="form-field" id="admission-year-field">
          <label class="field-label">入学年份</label>
          <picker 
            mode="date"
            fields="year"
            value="{{profileForm.admissionYear}}"
            disabled="{{!isEditingProfile}}"
            data-field="admissionYear"
            bindchange="onProfileInputChange"
          >
            <view class="picker-view {{profileErrors.admissionYear ? 'error' : ''}}">
              <text>{{profileForm.admissionYear}}年</text>
            </view>
          </picker>
          <text class="error-text" wx:if="{{profileErrors.admissionYear}}">{{profileErrors.admissionYear}}</text>
        </view>

        <!-- Birthday -->
        <view class="form-field" id="birthday-field">
          <label class="field-label">生日</label>
          <picker 
            mode="date"
            value="{{profileForm.birthday}}"
            disabled="{{!isEditingProfile}}"
            data-field="birthday"
            bindchange="onProfileInputChange"
          >
            <view class="picker-view {{profileErrors.birthday ? 'error' : ''}}">
              <text wx:if="{{profileForm.birthday}}">{{profileForm.birthday}}</text>
              <text wx:else class="placeholder">请选择生日</text>
            </view>
          </picker>
          <text class="error-text" wx:if="{{profileErrors.birthday}}">{{profileErrors.birthday}}</text>
        </view>
      </view>
      
      <!-- Password Change Section for non-company users -->
      <view wx:if="{{userInfo.role !== 'company'}}" class="form-section">
        <view class="section-title">密码管理</view>
        
        <view class="form-field">
          <label class="field-label">当前密码</label>
          <view class="input-wrapper">
            <input 
              class="field-input {{passwordErrors.old_password ? 'error' : ''}}"
              password="{{true}}"
              value="{{passwordForm.old_password}}"
              placeholder="请输入当前密码"
              data-field="old_password"
              bindinput="onPasswordInputChange"
            />
          </view>
          <text class="error-text" wx:if="{{passwordErrors.old_password}}">{{passwordErrors.old_password}}</text>
        </view>

        <view class="form-field">
          <label class="field-label">新密码</label>
          <view class="input-wrapper">
            <input 
              class="field-input {{passwordErrors.new_password ? 'error' : ''}}"
              password="{{true}}"
              value="{{passwordForm.new_password}}"
              placeholder="请输入新密码 (6-20位)"
              data-field="new_password"
              bindinput="onPasswordInputChange"
            />
          </view>
          <text class="error-text" wx:if="{{passwordErrors.new_password}}">{{passwordErrors.new_password}}</text>
        </view>

        <view class="form-field">
          <label class="field-label">确认新密码</label>
          <view class="input-wrapper">
            <input 
              class="field-input {{passwordErrors.new_password_confirmation ? 'error' : ''}}"
              password="{{true}}"
              value="{{passwordForm.new_password_confirmation}}"
              placeholder="请再次输入新密码"
              data-field="new_password_confirmation"
              bindinput="onPasswordInputChange"
            />
          </view>
          <text class="error-text" wx:if="{{passwordErrors.new_password_confirmation}}">{{passwordErrors.new_password_confirmation}}</text>
        </view>

        <!-- Change Password Button -->
        <view class="password-actions">
          <view class="action-button change-password-btn" bindtap="changePassword">
            <text class="button-label" wx:if="{{!passwordChanging}}">修改密码</text>
            <text class="button-label" wx:else>修改中...</text>
          </view>
        </view>

        <!-- Success/Error Messages -->
        <view wx:if="{{passwordMessage}}" class="success-message">
          <text>{{passwordMessage}}</text>
        </view>
        <view wx:if="{{passwordError}}" class="error-message">
          <text>{{passwordError}}</text>
        </view>
      </view>

      <!-- WeChat Linking Section for non-company users -->
      <view wx:if="{{userInfo.role !== 'company'}}" class="form-section">
        <view class="section-title">微信绑定</view>
        
        <view class="form-field">
          <label class="field-label">微信账号</label>
          <view class="wechat-status-container">
            <view class="wechat-status-row">
              <view class="wechat-status {{isWechatLinked ? 'linked' : 'unlinked'}}">
                <view class="wechat-status-icon">
                  <text wx:if="{{isWechatLinked}}">✅</text>
                  <text wx:else>❌</text>
                </view>
                <view class="wechat-status-text">
                  <text wx:if="{{isWechatLinked}}">已绑定微信</text>
                  <text wx:else>未绑定微信</text>
                </view>
              </view>
              
              <!-- WeChat Action Button moved next to status -->
              <view class="wechat-actions-inline">
                <view 
                  wx:if="{{!isWechatLinked}}"
                  class="action-button wechat-link-btn link-btn"
                  bindtap="linkWechat"
                >
                  <text class="button-label" wx:if="{{!wechatLinking}}">绑定</text>
                  <text class="button-label" wx:else>绑定中</text>
                </view>
                
                <view 
                  wx:if="{{isWechatLinked}}"
                  class="action-button wechat-link-btn unlink-btn"
                  bindtap="unlinkWechat"
                >
                  <text class="button-label" wx:if="{{!wechatLinking}}">解除</text>
                  <text class="button-label" wx:else>处理中</text>
                </view>
              </view>
            </view>
          </view>
          
          <view class="wechat-description">
            <text wx:if="{{!isWechatLinked}}">绑定微信后可使用微信快捷登录</text>
            <text wx:else>您可以使用微信登录或解除绑定</text>
          </view>
        </view>
        
        <!-- Logout Button moved here -->
        <view class="form-field logout-section">
          <view class="logout-button-container">
            <view class="action-button logout-button" bindtap="handleLogout">
              <image class="image-icon" src="/images/icons/logout.svg"></image>
              <text class="button-label">退出登录</text>
            </view>
          </view>
        </view>
      </view>
    </view>
  </view>
</app-layout>
