<!-- Profile Page -->
<app-layout current-page="profile">
  <view class="profile-container"><!-- Avatar Section - Horizontal Layout with Edit/Cancel Buttons -->
    <view class="avatar-section-horizontal">
      <view class="avatar-container-horizontal" bindtap="selectAvatar">
        <avatar class="avatar-medium" avatar="{{selectedAvatar || userInfo.avatar}}" name="{{userInfo.username}}" size="120" mode="aspectFill" />
        <view class="avatar-overlay" wx:if="{{isEditingProfile}}">
          <text class="avatar-edit-icon">ğŸ“·</text>
        </view>
      </view>
      <view class="user-info-horizontal">
        <text class="user-name-horizontal">{{userInfo.name || userInfo.username}}</text>
        <text class="user-university-horizontal">{{university.name || 'æœªè®¾ç½®å¤§å­¦'}}</text>
      </view>
      
      <!-- Edit/Cancel Buttons moved here -->
      <view class="avatar-right-buttons">
        <!-- Edit Mode: Show Save and Cancel buttons -->
        <view class="action-buttons-container" wx:if="{{isEditingProfile}}">
          <view class="action-button save-button" bindtap="saveProfile">
            <text class="button-icon">âœ“</text>
            <text class="button-label">ä¿å­˜</text>
          </view>
          <view class="action-button cancel-button" bindtap="cancelProfileEdit">
            <text class="button-icon">âœ•</text>
            <text class="button-label">å–æ¶ˆ</text>
          </view>
        </view>
        
        <!-- View Mode: Show Edit button only -->
        <view class="action-buttons-container" wx:else>
          <view class="action-button edit-button" bindtap="toggleProfileEdit">
            <image class="image-icon" src="/images/icons/edit.svg"></image>
            <text class="button-label">ç¼–è¾‘</text>
          </view>
        </view>
      </view>
    </view>

    <!-- Profile Form -->
    <view class="profile-form">
      <!-- Basic Information -->
      <view class="form-section">
        <view class="section-title">åŸºæœ¬ä¿¡æ¯</view>
          <!-- Name -->
        <view class="form-field" id="name-field">
          <label class="field-label">å§“å</label>
          <view class="input-wrapper">
            <input 
              class="field-input {{profileErrors.name ? 'error' : ''}}"
              value="{{profileForm.name}}"
              placeholder="è¯·è¾“å…¥å§“å"
              disabled="{{!isEditingProfile}}"
              data-field="name"
              bindinput="onProfileInputChange"
            />
          </view>
          <text class="error-text" wx:if="{{profileErrors.name}}">{{profileErrors.name}}</text>
        </view>

        <!-- Nickname -->
        <view class="form-field" id="nickname-field">
          <label class="field-label">æ˜µç§°</label>
          <view class="input-wrapper">
            <input 
              class="field-input {{profileErrors.nickname ? 'error' : ''}}"
              value="{{profileForm.nickname}}"
              placeholder="è¯·è¾“å…¥æ˜µç§°"
              disabled="{{!isEditingProfile}}"
              data-field="nickname"
              bindinput="onProfileInputChange"
            />
          </view>
          <text class="error-text" wx:if="{{profileErrors.nickname}}">{{profileErrors.nickname}}</text>
        </view>

        <!-- Phone -->
        <view class="form-field" id="phone-field">
          <label class="field-label">
            æ‰‹æœºå·
            <view class="verification-status" wx:if="{{phoneChanged && !phoneVerified}}">
              <text class="status-text">éœ€è¦éªŒè¯</text>
            </view>
          </label>
          <view class="input-wrapper">
            <view class="phone-input">
              <text class="phone-prefix">+86</text>
              <input 
                class="field-input phone-number {{profileErrors.phone ? 'error' : ''}}"
                value="{{profileForm.phone}}"
                placeholder="è¯·è¾“å…¥æ‰‹æœºå·"
                disabled="{{!isEditingProfile}}"
                data-field="phone"
                bindinput="onProfileInputChange"
              />
            </view>
          </view>
          
          <!-- Phone Verification Section -->
          <view wx:if="{{phoneChanged && !phoneVerified && isEditingProfile}}" class="verification-section">
            <view class="profile-action-btn send-code-btn" bindtap="sendPhoneVerificationCode">
              <text class="btn-text">å‘é€éªŒè¯ç </text>
            </view>
            <view class="otp-input-container">
              <view class="input-wrapper">
                <input 
                  class="otp-input"
                  placeholder="è¯·è¾“å…¥æ‰‹æœºéªŒè¯ç "
                  value="{{phoneOtpCode}}"
                  bindinput="onPhoneOtpInput"
                />
              </view>
              <view class="profile-action-btn verify-code-btn" bindtap="verifyPhoneCode">
                <text class="btn-text">éªŒè¯</text>
              </view>
            </view>
          </view>
          
          <text class="error-text" wx:if="{{profileErrors.phone}}">{{profileErrors.phone}}</text>
        </view>        <!-- Email -->
        <view class="form-field" id="email-field">
          <label class="field-label">
            é‚®ç®±
            <view class="verification-status" wx:if="{{emailChanged && !emailVerified}}">
              <text class="status-text">éœ€è¦éªŒè¯</text>
            </view>
          </label>
          <view class="input-wrapper">
            <input 
              class="field-input {{profileErrors.email ? 'error' : ''}}"
              value="{{profileForm.email}}"
              placeholder="è¯·è¾“å…¥é‚®ç®±"
              disabled="{{!isEditingProfile}}"
              data-field="email"
              bindinput="onProfileInputChange"
            />
          </view>
          
          <!-- Email Verification Section -->
          <view wx:if="{{emailChanged && !emailVerified && isEditingProfile}}" class="verification-section">
            <view class="profile-action-btn send-code-btn" bindtap="sendEmailVerificationCode">
              <text class="btn-text">å‘é€éªŒè¯ç </text>
            </view>
            <view class="otp-input-container">
              <view class="input-wrapper">
                <input 
                  class="otp-input"
                  placeholder="è¯·è¾“å…¥é‚®ç®±éªŒè¯ç "
                  value="{{emailOtpCode}}"
                  bindinput="onEmailOtpInput"
                />
              </view>
              <view class="profile-action-btn verify-code-btn" bindtap="verifyEmailCode">
                <text class="btn-text">éªŒè¯</text>
              </view>
            </view>
          </view>
          
          <text class="error-text" wx:if="{{profileErrors.email}}">{{profileErrors.email}}</text>
        </view>

        <!-- Gender -->
        <view class="form-field" id="gender-field">
          <label class="field-label">æ€§åˆ«</label>
          <view class="gender-options">
            <view 
              class="gender-option {{profileForm.gender === 'male' ? 'selected' : ''}} {{!isEditingProfile ? 'disabled' : ''}}"
              data-gender="male"
              bindtap="{{isEditingProfile ? 'onGenderChange' : ''}}"
            >
              <text class="gender-icon">â™‚</text>
              <text class="gender-text">ç”·</text>
            </view>
            <view 
              class="gender-option {{profileForm.gender === 'female' ? 'selected' : ''}} {{!isEditingProfile ? 'disabled' : ''}}"
              data-gender="female"
              bindtap="{{isEditingProfile ? 'onGenderChange' : ''}}"
            >
              <text class="gender-icon">â™€</text>
              <text class="gender-text">å¥³</text>
            </view>
          </view>
          <text class="error-text" wx:if="{{profileErrors.gender}}">{{profileErrors.gender}}</text>
        </view>
      </view>

      <!-- Academic Information -->
      <view class="form-section">
        <view class="section-title">å­¦æœ¯ä¿¡æ¯</view>
          <!-- ID Number -->
        <view class="form-field" id="id-number-field">
          <label class="field-label">èº«ä»½è¯å·</label>
          <view class="input-wrapper">
            <input 
              class="field-input {{profileErrors.id_number ? 'error' : ''}}"
              value="{{profileForm.id_number}}"
              placeholder="è¯·è¾“å…¥èº«ä»½è¯å·"
              disabled="{{!isEditingProfile}}"
              data-field="id_number"
              bindinput="onProfileInputChange"
            />
          </view>
          <text class="error-text" wx:if="{{profileErrors.id_number}}">{{profileErrors.id_number}}</text>
        </view>

        <!-- Student Number -->
        <view class="form-field" id="student-number-field">
          <label class="field-label">å­¦å·</label>
          <view class="input-wrapper">
            <input 
              class="field-input {{profileErrors.student_number ? 'error' : ''}}"
              value="{{profileForm.student_number}}"
              placeholder="è¯·è¾“å…¥å­¦å·"
              disabled="{{!isEditingProfile}}"
              data-field="student_number"
              bindinput="onProfileInputChange"
            />
          </view>
          <text class="error-text" wx:if="{{profileErrors.student_number}}">{{profileErrors.student_number}}</text>
        </view>

        <!-- Faculty -->
        <view class="form-field" id="faculty-field">
          <label class="field-label">å­¦é™¢</label>
          <picker 
            mode="selector"
            range="{{faculties}}"
            range-key="name"
            value="{{facultyIndex}}"
            disabled="{{!isEditingProfile}}"
            data-field="faculty"
            bindchange="onProfileInputChange"
          >
            <view class="picker-view {{profileErrors.faculty ? 'error' : ''}}">
              <text wx:if="{{profileForm.faculty}}">{{profileForm.faculty}}</text>
              <text wx:else class="placeholder">è¯·é€‰æ‹©å­¦é™¢</text>
            </view>
          </picker>
          <text class="error-text" wx:if="{{profileErrors.faculty}}">{{profileErrors.faculty}}</text>
        </view>

        <!-- Major -->
        <view class="form-field" id="major-field">
          <label class="field-label">ä¸“ä¸š</label>
          <picker 
            mode="selector"
            range="{{availableMajors}}"
            range-key="name"
            value="{{majorIndex}}"
            disabled="{{!isEditingProfile || !profileForm.faculty}}"
            data-field="major"
            bindchange="onProfileInputChange"
          >
            <view class="picker-view {{profileErrors.major ? 'error' : ''}}">
              <text wx:if="{{profileForm.major}}">{{profileForm.major}}</text>
              <text wx:else class="placeholder">è¯·é€‰æ‹©ä¸“ä¸š</text>
            </view>
          </picker>
          <text class="error-text" wx:if="{{profileErrors.major}}">{{profileErrors.major}}</text>
        </view>        <!-- Class -->
        <view class="form-field" id="class-field">
          <label class="field-label">ç­çº§</label>
          <view class="input-wrapper">
            <input 
              class="field-input {{profileErrors.class ? 'error' : ''}}"
              value="{{profileForm.class}}"
              placeholder="è¯·è¾“å…¥ç­çº§"
              disabled="{{!isEditingProfile}}"
              data-field="class"
              bindinput="onProfileInputChange"
            />
          </view>
          <text class="error-text" wx:if="{{profileErrors.class}}">{{profileErrors.class}}</text>
        </view>

        <!-- Admission Year -->
        <view class="form-field">
          <label class="field-label">å…¥å­¦å¹´ä»½</label>
          <picker 
            mode="date"
            fields="year"
            value="{{profileForm.admissionYear}}"
            disabled="{{!isEditingProfile}}"
            data-field="admissionYear"
            bindchange="onProfileInputChange"
          >
            <view class="picker-view">
              <text>{{profileForm.admissionYear}}å¹´</text>
            </view>
          </picker>
        </view>
      </view>      <!-- WeChat Linking Section -->
      <view class="form-section">
        <view class="section-title">å¾®ä¿¡ç»‘å®š</view>
        
        <view class="form-field">
          <label class="field-label">å¾®ä¿¡è´¦å·</label>
          <view class="wechat-status-container">
            <view class="wechat-status-row">
              <view class="wechat-status {{isWechatLinked ? 'linked' : 'unlinked'}}">
                <view class="wechat-status-icon">
                  <text wx:if="{{isWechatLinked}}">âœ…</text>
                  <text wx:else>âŒ</text>
                </view>
                <view class="wechat-status-text">
                  <text wx:if="{{isWechatLinked}}">å·²ç»‘å®šå¾®ä¿¡</text>
                  <text wx:else>æœªç»‘å®šå¾®ä¿¡</text>
                </view>
              </view>
              
              <!-- WeChat Action Button moved next to status -->
              <view class="wechat-actions-inline">
                <view 
                  wx:if="{{!isWechatLinked}}"
                  class="action-button wechat-link-btn link-btn"
                  bindtap="linkWechat"
                >
                  <text class="button-label" wx:if="{{!wechatLinking}}">ç»‘å®š</text>
                  <text class="button-label" wx:else>ç»‘å®šä¸­</text>
                </view>
                
                <view 
                  wx:if="{{isWechatLinked}}"
                  class="action-button wechat-link-btn unlink-btn"
                  bindtap="unlinkWechat"
                >
                  <text class="button-label" wx:if="{{!wechatLinking}}">è§£é™¤</text>
                  <text class="button-label" wx:else>å¤„ç†ä¸­</text>
                </view>
              </view>
            </view>
          </view>
          
          <view class="wechat-description">
            <text wx:if="{{!isWechatLinked}}">ç»‘å®šå¾®ä¿¡åå¯ä½¿ç”¨å¾®ä¿¡å¿«æ·ç™»å½•</text>
            <text wx:else>æ‚¨å¯ä»¥ä½¿ç”¨å¾®ä¿¡ç™»å½•æˆ–è§£é™¤ç»‘å®š</text>
          </view>
        </view>
        
        <!-- Logout Button moved here -->
        <view class="form-field logout-section">
          <view class="logout-button-container">
            <view class="action-button logout-button" bindtap="handleLogout">
              <image class="image-icon" src="/images/icons/logout.svg"></image>
              <text class="button-label">é€€å‡ºç™»å½•</text>
            </view>
          </view>
        </view>
      </view>
    </view>
  </view>
</app-layout>
