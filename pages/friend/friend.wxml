<!--pages/friend/friend.wxml-->
<wxs src="../../utils/userDisplayName.wxs" module="userUtils" />
<app-layout current-page="friend">

  <!-- Main content container -->
  <view class="content-container {{userInfo.role === 'teacher' ? 'teacher-layout' : ''}}" wx:if="{{!loading || filteredUserList.length > 0 || showUserMedia}}">
    <!-- User List View -->
    <view class="user-list" wx:if="{{!showUserMedia}}">
      <!-- Search Bar -->
      <view class="search-container">
        <view class="search-box">
          <view class="search-icon">ğŸ”</view>
          <input 
            class="search-input" 
            type="text" 
            placeholder="æœç´¢å¥½å‹" 
            value="{{searchValue}}"
            bindinput="searchUsers"
            confirm-type="search"
          />
          <view class="clear-icon" bindtap="clearSearch" wx:if="{{searchValue}}">âœ•</view>
        </view>
      </view>
      
      <!-- No results message -->
      <view class="no-results" wx:if="{{filteredUserList.length === 0}}">
        <text>æœªæ‰¾åˆ°åŒ¹é…çš„ç”¨æˆ·</text>
      </view>
      
      <!-- User list items -->
      <view class="user-item" wx:for="{{filteredUserList}}" wx:key="id" bindtap="selectUser" data-id="{{item.id}}">
        <avatar class="user-avatar" avatar="{{item.avatar}}" user="{{item}}" size="{{70}}"></avatar>
        <view class="user-info">
          <text class="user-nickname">{{userUtils.getShortDisplayName(item, 10)}}<text wx:if="{{userUtils.isCompany(item)}}" class="company-badge-small">ä¼ä¸š</text></text>
          <text class="user-followers">ç²‰ä¸ {{item.followers}}äºº</text>
        </view>
        <view class="user-arrow">
          <image class="back-icon" src="/images/icons/chevron-right.svg"></image>
        </view>
      </view>    
    </view>  
    <view class="user-media-container" wx:if="{{showUserMedia}}">
      <!-- Media header with back button and user profile -->
      <view class="media-header">
        <view class="back-button" bindtap="backToUserList">
          <image class="back-icon" src="/images/icons/back.svg"></image>
        </view>
        <view class="user-profile-header">
          <view class="profile-info">
            <avatar class="profile-avatar" avatar="{{currentUser.avatar}}" user="{{currentUser}}" size="{{80}}" mode="aspectFit"></avatar>
            <view class="profile-details">
              <view class="username-container">
                <text class="profile-username">{{userUtils.getDisplayName(currentUser)}}<text wx:if="{{userUtils.isCompany(currentUser)}}" class="company-badge">ä¼ä¸š</text></text>
              </view>
              <text wx:if="{{!userUtils.isCompany(currentUser)}}" class="profile-university">{{(currentUser.university && currentUser.university.name) || 'æœªè®¾ç½®å¤§å­¦'}}</text>
              <text wx:if="{{!userUtils.isCompany(currentUser)}}" class="profile-faculty">{{currentUser.faculty || 'æœªè®¾ç½®å­¦é™¢'}}</text>
            </view>
          </view>
        </view>
      </view>
      
      <!-- Action buttons for follow, friend, and message -->
      <view class="action-buttons">
        <!-- Follow/Unfollow Button -->
        <button 
          class="action-btn {{currentUser.isFollowed ? 'followed' : 'default'}}" 
          bindtap="handleFollowToggle">
          <text class="btn-text">{{currentUser.isFollowed ? 'å·²å…³æ³¨' : 'å…³æ³¨'}}</text>
        </button>

        <!-- Friend Button -->
        <button 
          class="action-btn {{currentUser.isFriend ? (currentUser.isAllow ? 'friend' : 'pending') : 'default'}}" 
          bindtap="handleFriendToggle">
          <text class="btn-text">{{currentUser.isFriend ? 'å¥½å‹' : 'åŠ å¥½å‹'}}</text>
        </button>

        <!-- Message Button (only shown if they are friends) -->
        <button 
          class="action-btn default" 
          bindtap="handleSendMessage"
          wx:if="{{currentUser.isFriend}}">
          <text class="btn-text">ç•™è¨€</text>
        </button>
      </view>
      <view class="media-grid">
        <view class="media-item" wx:for="{{userMediaList}}" wx:key="id" bindtap="previewImage" data-id="{{item.id}}">
          <view class="media-container">
            <image wx:if="{{item.type=='image'}}" class="media-image" src="{{item.media[0].url}}" mode="aspectFill"></image>
            <image wx:else class="media-image" src="{{item.media[0].preview_url}}" mode="aspectFill"></image>
            <view class="media-overlay">
              <text class="likes-count">â™¥ {{item.likes}}</text>
            </view>
          </view>
        </view>
      </view>

      <!-- Loading indicator -->
      
      <!-- No more content message -->
      <view class="no-more" wx:if="{{!hasMore && userMediaList.length > 0}}">
        <text>æ²¡æœ‰æ›´å¤šå†…å®¹</text>
      </view>
    </view>
  </view>
</app-layout>