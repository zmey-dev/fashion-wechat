<app-layout current-page="event">
  <view class="event-detail-container {{userInfo.role === 'teacher' ? 'teacher-layout' : ''}} {{isExpired ? 'index-bg' : ''}}">
    <!-- Content Container -->
    <view class="content-wrapper">
      <!-- Event Header with Poster -->
      <view wx:if="{{event.poster_image}}" class="event-header">
        <image class="header-image" src="{{event.poster_image}}" mode="widthFix"></image>
      </view>

      <!-- Join Event Button and Warnings (moved below poster) -->
      <view class="event-actions-section">
        <!-- Join Event Button (User Role Only) -->
        <view wx:if="{{userInfo.role === 'user' && canJoinEvent}}" class="join-actions">
          <button class="join-btn" bindtap="onJoinEvent">
            参加活动
          </button>
        </view>
        
        <!-- Warning for other schools -->
        <view wx:if="{{userInfo.role === 'user' && !event.allow_other_school && userInfo.university_id !== event.user.university_id}}" class="join-warning">
          <text class="warning-text">该活动不允许外校报名</text>
        </view>
        
        <!-- Full capacity warning -->
        <view wx:if="{{event.allow_limit && event.students_count >= event.limit}}" class="join-warning">
          <text class="warning-text">该活动已满员</text>
        </view>
      </view>

      <!-- Event Info Section -->
      <view class="event-info-section">
        <view class="info-container">
          <view class="event-title-wrapper">
            <text class="event-title" style="color: {{event.title_color || '#FFFFFF'}};">{{event.title || '活动发现页'}}</text>
            
            <view class="event-meta">
              <!-- Date Info -->
              <view wx:if="{{event.start_date && event.end_date}}" class="meta-item">
                <image class="meta-icon calendar" src="/images/icons/calendar.svg"></image>
                <text class="meta-text">{{event.formatted_start_date}} - {{event.formatted_end_date}}</text>
              </view>
              
              <!-- Current Time -->
              <view class="meta-item">
                <image class="meta-icon clock" src="/images/icons/clock.svg"></image>
                <text class="meta-text">今日: {{currentDate}} {{currentTime}}</text>
              </view>
              
              <!-- Participants -->
              <view class="meta-item">
                <image class="meta-icon users" src="/images/icons/users.svg"></image>
                <text class="meta-text">{{event.students_count || 0}} 参与者</text>
              </view>
              
              <!-- University -->
              <view wx:if="{{event.user.university.name}}" class="meta-item">
                <image class="meta-icon location" src="/images/icons/location.svg"></image>
                <text class="meta-text">{{event.user.university.name}}</text>
              </view>
            </view>
          </view>
        </view>
      </view>

      <!-- Event Description Section -->
      <view wx:if="{{event.description}}" class="event-description-section">
        <view class="description-header">
          <image class="header-icon" src="/images/icons/document-text.svg"></image>
          <text class="header-title">活动详情</text>
        </view>
        <view class="description-content">
          <rich-text class="rich-text-content" nodes="{{event.description}}"></rich-text>
        </view>
      </view>

      <!-- Posts Content Area -->
      <view class="content-area {{isExpired ? 'index-content' : ''}}">

        <!-- Empty State -->
        <view wx:if="{{!loading && posts.length === 0}}" class="empty-container">
          <view class="empty-content">
            <image class="empty-icon" src="/images/icons/users.svg"></image>
            <text class="empty-title">暂无作品可展示</text>
            <text class="empty-desc">敬请期待更多精彩内容</text>
          </view>
        </view>

        <!-- Posts Grid -->
        <view wx:else class="posts-grid {{isExpired ? 'index-style' : ''}}">
          <view 
            wx:for="{{posts}}" 
            wx:key="id"
            class="post-card {{isExpired ? 'index-card' : ''}}"
            data-post-id="{{item.id}}"
            data-index="{{index}}"
            bindtap="onPostTap"
          >
            <!-- Crown for Top 3 (show only for active events) -->
            <view wx:if="{{index < 3 && !isExpired && !viewOnly}}" class="crown-wrapper">
              <image class="crown-icon" src="/images/crown{{index}}.png" mode="aspectFit"></image>
            </view>

            <!-- Blocked Post Overlay -->
            <view wx:if="{{!item.active}}" class="blocked-overlay">
              <image class="ban-icon" src="/images/icons/ban.svg"></image>
              <text class="blocked-text">已阻止</text>
            </view>

            <!-- Media Container -->
            <view class="media-container">
              <image 
                class="post-image"
                src="{{item.type === 'video' ? item.media[0].preview_url : item.media[0].url}}"
                lazy-load="{{true}}"
                mode="aspectFill"
              />
              <!-- Video indicator -->
              <view wx:if="{{item.type === 'video'}}" class="video-indicator">
                <image class="video-icon" src="/images/icons/play.svg"></image>
              </view>
              <!-- Multiple media indicator -->
              <view wx:if="{{item.media && item.media.length > 1}}" class="multiple-indicator">
                <image class="multiple-icon" src="/images/icons/multiple.svg"></image>
              </view>
            </view>
            
            <!-- User Section (same as index page) - Only for expired events -->
            <view wx:if="{{isExpired}}" class="user-section">
              <view class="user-info">
                <view class="user-row" catchtap="onUserTap" data-username="{{item.user.username}}" data-userId="{{item.user.id}}">
                  <avatar avatar="{{item.user.avatar}}" user="{{item.user}}" size="45"></avatar>
                  <text class="user-name">{{item.user.nickname || item.user.username}}</text>
                </view>
              </view>
              <view class="like-display">
                <image class="heart-icon" src="/images/icons/heart.svg" mode="aspectFit"></image>
                <text class="like-count">{{item.likes}}</text>
              </view>
            </view>
            
            <!-- Original Post Info - Only for non-expired events -->
            <view wx:if="{{!isExpired}}" class="post-info">
              <view class="post-title-wrapper">
                <text class="post-title">{{item.title}}</text>
              </view>
              
              <view class="post-actions">
                <!-- Like Button (User Role Only) -->
                <view wx:if="{{userInfo.role === 'user'}}" class="like-section">
                  <view class="like-btn" bindtap="onLikePost" data-post-id="{{item.id}}" data-index="{{index}}">
                    <image 
                      class="heart-icon {{item.likes_exists ? 'liked' : ''}}" 
                      src="/images/icons/heart.svg"
                    ></image>
                    <text class="like-count">{{item.likes}}</text>
                  </view>
                </view>
              </view>
            </view>
          </view>
        </view>


        <!-- End Message -->
        <view wx:if="{{!hasMore && posts.length > 0}}" class="end-message">
          <text class="end-text">已经到底了</text>
        </view>
      </view>
    </view>

    <!-- Floating Action Buttons -->
    <view class="floating-actions">
      <view class="float-btn refresh" bindtap="onRefresh">
        <view wx:if="{{loading}}" class="loading-spinner mini"></view>
        <image wx:else class="btn-icon" src="/images/icons/refresh.svg"></image>
      </view>    
    </view>
  </view>

  <!-- Custom Description Modal -->
  <view wx:if="{{showDescriptionModal}}" class="description-modal-overlay" bindtap="hideDescriptionModal">
    <view class="description-modal" catchtap="stopPropagation">
      <view class="modal-header">
        <text class="modal-title">活动规则</text>
        <view class="modal-close" bindtap="hideDescriptionModal">✕</view>
      </view>
      <scroll-view class="modal-content" scroll-y="{{true}}" enhanced="{{true}}">
        <rich-text class="modal-rich-text" nodes="{{modalDescriptionNodes}}"></rich-text>
      </scroll-view>
      <view class="modal-footer">
        <button class="modal-btn cancel" bindtap="hideDescriptionModal">取消</button>
        <button class="modal-btn confirm" bindtap="confirmJoinEvent">确认参加</button>
      </view>
    </view>
  </view>
</app-layout>