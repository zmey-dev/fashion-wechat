<!-- pages/post-detail/post-detail.wxml -->
<app-layout current-page="{{ sourcePage }}">
  <!-- Login Modal -->
  <login-modal wx:if="{{ showLoginModal }}" class="login-modal" />
  
  <!-- Post Viewer Container with Swiper -->
  <view class="post-viewer-container {{userInfo.role === 'teacher' ? 'teacher-layout' : ''}}">
    <!-- Vertical Swiper for Infinite Scroll -->
    <swiper 
      wx:if="{{ posts.length > 0 }}"
      class="posts-swiper"
      vertical="{{ true }}"
      current="{{ currentIndex }}"
      duration="300"
      bindchange="onSwiperChange"
      bindanimationfinish="onAnimationFinish"
      circular="{{ false }}"
      style="height: calc(100vh - 240rpx); width: 100vw;"
    >
      <swiper-item 
        wx:for="{{ posts }}" 
        wx:key="id"
        class="swiper-item"
      >
        <media-player
          id="media-player-{{index}}"
          selectedPost="{{ item }}"
          selectedPostUser="{{ item.user }}"
          followedUsers="{{ followedUsers }}"
          authUser="{{ userInfo }}"
          index="{{ index }}"
          totalCount="{{ posts.length }}"
          event-id="{{ eventId }}"
          is-event-expired="{{ isEventExpired }}"
          is-loading="{{ false }}"
          is-continue="{{ globalIsContinue }}"
          is-playing="{{ false }}"
          bind:postNavigation="handlePostNavigation"
          bind:likeUpdated="handleLikeUpdated"
          bind:favoriteUpdated="handleFavoriteUpdated"
          bind:shareUpdated="handleShareUpdated"
          bind:followUpdated="handleFollowUpdated"
          bind:showLogin="showLoginModal"
          bind:navigateToProfile="navigateToUserProfile"
          bind:videoEnded="handleVideoEnded"
          bind:imageSlideEnded="handleImageSlideEnded"
          bind:continueToggled="handleContinueToggled"
        >
        </media-player>
      </swiper-item>
    </swiper>

    
    
    <!-- Error State - Show when there's an error after attempting to load -->
    <view wx:elif="{{ hasError && hasLoadedOnce }}" class="error-container">
      <view class="error-icon">⚠️</view>
      <text class="error-text">{{errorMessage}}</text>
      <button class="retry-btn" bindtap="onRetry">重试</button>
    </view>
    
    <!-- Empty State - Only show when truly no content and not during any transitions -->
    <view wx:elif="{{ !post && !isLoading && !hasError && hasLoadedOnce && !isNavigating && !isTransitioning }}" class="empty-container">
      <view class="empty-icon">📭</view>
      <text class="empty-text">内容不存在</text>
      <button class="back-btn" bindtap="onRetry">返回</button>
    </view>

  </view>
</app-layout>
