<!-- pages/chat/chat.wxml -->
<view class="app-container">
  <!-- Chat List View -->
  <view class="chat-list-view {{currentView === 'list' ? 'active' : 'hidden'}}" >
    <!-- Header -->
    <view class="list-header">
      <view class="header-title">èŠå¤©</view>
    </view>

    <!-- Search Bar -->
    <view class="search-container">
      <view class="search-box">
        <view class="search-icon">ğŸ”</view>
        <input 
          class="search-input" 
          placeholder="æœç´¢"
          value="{{searchText}}"
          bindinput="onSearchInput"
        />
      </view>
    </view>

    <!-- Friends List -->
    <scroll-view class="friends-list" scroll-y enhanced="{{true}}" show-scrollbar="{{false}}">
      <view 
        wx:for="{{filteredFriends}}" 
        wx:key="id"
        class="chat-item relative"
        data-userid="{{item.id}}"
        bindtap="onSelectUser"
        bindlongpress="onLongPress"
        hover-class="chat-item-hover"
        hover-stay-time="100"
      >
        <view class="friend-avatar-container relative">
          <avatar 
            class="friend-avatar" 
            avatar="{{item.avatar}}"
            name="{{item.username}}"
            size="{{80}}"
            mode="aspectFill"
            lazy-load="{{true}}"
          />
          <!-- Unread message badge -->
          <view wx:if="{{item.unreadCount > 0}}" class="unread-badge absolute top-0 right-0">
            {{item.unreadCount}}
          </view>
          <!-- Online status indicator -->
          <view wx:if="{{item.status === 'online'}}" class="online-indicator absolute bottom-0 right-0.5 h-2 w-2 rounded-full bg-green-500 border-2 border-white"></view>
        </view>
        
        <view class="friend-content">
          <view class="friend-main">
            <view class="friend-name">{{item.username}}</view>
            <view class="timestamp">{{item.timestamp || ''}}</view>
          </view>
          
          <view class="friend-bottom">
            <view class="last-message">{{item.lastMessage || ''}}</view>
          </view>
        </view>
        
        <!-- Typing indicator - similar to React version -->
        <view wx:if="{{friendsTyping[item.id]}}" class="typing-text">
          æ­£åœ¨è¾“å…¥...
        </view>
      </view>
    </scroll-view>
  </view>

  <!-- Chat Detail View -->
  <view class="chat-detail-view {{currentView === 'chat' ? 'active' : 'hidden'}}">
    <!-- Chat Header -->
    <view class="chat-header">
      <view class="header-left">
        <view class="back-btn" bindtap="onBackToList">
          â† 
        </view>
        <view class="relative" style="height: 80rpx; margin-right: 20rpx;">
          <avatar 
            class="user-avatar" 
            avatar="{{selectedUser.avatar}}"
            name="{{selectedUser.username}}"
            size="{{80}}"
            mode="aspectFill"
          />
          <!-- Online status indicator in chat header -->
          <view wx:if="{{selectedUser.status === 'online'}}" class="online-indicator absolute bottom-0 right-0.5 h-2 w-2 rounded-full bg-green-500 border-2 border-white"></view>
        </view>
        <view class="user-info">
          <view class="user-name">{{selectedUser.username}}</view>
          <!-- Show typing indicator in header when user is typing -->
          <view wx:if="{{friendsTyping[selectedUser.id]}}" class="header-typing-indicator">
            <text class="header-typing-text">æ­£åœ¨è¾“å…¥...</text>
            <view class="header-typing-dots">
              <view class="header-typing-dot"></view>
              <view class="header-typing-dot"></view>
              <view class="header-typing-dot"></view>
            </view>
          </view>
          <!-- Show status when not typing -->
          <view wx:else class="user-status">{{selectedUser.status === 'online' ? 'åœ¨çº¿' : 'ç¦»çº¿'}}</view>
        </view>
      </view>
      <view class="header-actions">
        <view class="action-icon">ğŸ“</view>
        <view class="action-icon">ğŸ“¹</view>
        <view class="action-icon">â‹¯</view>
      </view>
    </view>

    <!-- Messages Container -->
    <scroll-view 
      class="messages-container"
      scroll-y
      enhanced="{{true}}"
      show-scrollbar="{{false}}"
      scroll-into-view="{{scrollIntoView}}"
      scroll-with-animation="{{true}}"
      style="bottom: {{keyboardHeight + 100}}px;"
    >
      <view class="messages-list">
        <view 
          wx:for="{{messages}}" 
          wx:key="id"
          id="msg-{{index}}"
          class="message-wrapper"
        >
          <view wx:if="{{index === 0 || shouldShowDateSeparator(item, messages[index-1])}}" class="date-separator">
            <view class="date-text">{{formatDate(item.updated_at)}}</view>
          </view>
          
          <view wx:if="{{item.sender_id !== 'me'}}" class="message-group received">
            <avatar 
              class="message-avatar" 
              avatar="{{selectedUser.avatar}}"
              name="{{selectedUser.username}}"
              size="{{80}}"
              mode="aspectFill"
            />
            <view class="message-bubble received-bubble {{isEmojiOnly(item.message) ? 'emoji-only' : ''}}">
              <view class="message-text">{{item.message}}</view>
              <view class="message-time">{{item.formatted_time}}</view>
            </view>
          </view>

          <view wx:if="{{item.sender_id === 'me'}}" class="message-group sent">
            <avatar 
              class="message-avatar" 
              avatar="{{userInfo.avatar}}"
              name="{{userInfo.username}}"
              size="{{80}}"
              mode="aspectFill"
            />
            
            <view class="message-bubble sent-bubble {{isEmojiOnly(item.message) ? 'emoji-only' : ''}}">
              <view class="message-text">{{item.message}}</view>
              <view class="message-info">
                <view class="message-time">{{item.formatted_time}}</view>
              </view>
            </view>
            
            <!-- Add seen indicator on the left side of the message bubble -->
            <view wx:if="{{item.id === lastViewedMessageId}}" class="message-seen-indicator-left">
              <view class="seen-icon">
                <!-- SVG Eye Icon -->
                <image src="/images/icons/eye.svg" class="seen-icon" mode="aspectFit" />
              </view>
            </view>
          </view>
        </view>
      </view>

      <!-- Typing indicator - Mobile optimized version -->
      <view wx:if="{{friendIsTyping}}" class="typing-indicator-container">
        <view class="typing-avatar">
          <avatar 
            avatar="{{selectedUser.avatar}}"
            name="{{selectedUser.username}}"
            size="{{60}}"
            mode="aspectFill"
          />
        </view>
        <view class="typing-bubble">
          <view class="typing-dots">
            <view class="typing-dot"></view>
            <view class="typing-dot"></view>
            <view class="typing-dot"></view>
          </view>
        </view>
      </view>

      <!-- Only show typing indicator if selected user is typing -->
      <view wx:if="{{selectedUser && friendsTyping[selectedUser.id]}}" class="typing-indicator-container">
        <view class="typing-avatar">
          <avatar 
            avatar="{{selectedUser.avatar}}"
            name="{{selectedUser.username}}"
            size="{{60}}"
            mode="aspectFill"
          />
        </view>
        <view class="typing-bubble">
          <view class="typing-dots">
            <view class="typing-dot"></view>
            <view class="typing-dot"></view>
            <view class="typing-dot"></view>
          </view>
        </view>
      </view>
    </scroll-view>

    <!-- Emoji Picker -->
    <view wx:if="{{showEmojiPicker}}" class="emoji-picker" style="bottom: {{keyboardHeight + 60}}px;">
      <scroll-view class="emoji-grid" scroll-y enhanced="{{true}}" show-scrollbar="{{false}}">
        <view 
          wx:for="{{emojis}}" 
          wx:key="*this"
          class="emoji-item"
          data-emoji="{{item}}"
          bindtap="onEmojiSelect"
          hover-class="emoji-item-hover"
          hover-stay-time="100"
        >
          {{item}}
        </view>
      </scroll-view>
    </view>

    <!-- Message Input -->
    <view class="message-input-container" style="bottom: {{keyboardHeight}}px;">
      <view class="input-box">
        <view class="input-actions-left">
          <view class="input-action-btn" bindtap="toggleEmojiPicker">
            {{showEmojiPicker ? 'âŒ¨ï¸' : 'ğŸ˜Š'}}
          </view>
        </view>
        
        <input 
          class="message-input"
          placeholder="æ¶ˆæ¯"
          value="{{inputMessage}}"
          bindinput="onInputChange"
          bindfocus="onInputFocus"
          bindblur="onInputBlur"
          bindkeyboardheightchange="onKeyboardHeightChange"
          confirm-type="send"
          bindconfirm="onSendMessage"
          adjust-position="{{false}}"
          hold-keyboard="{{true}}"
        />
        
        <view class="input-actions-right">
          <view wx:if="{{inputMessage.length > 0}}" class="send-btn" bindtap="onSendMessage">
            â¤
          </view>
          <view wx:else class="input-action-btn"></view>
        </view>
      </view>
    </view>
  </view>

  <!-- Context Menu -->
  <view 
    wx:if="{{contextMenu.visible}}" 
    class="context-overlay"
    bindtap="hideContextMenu"
  >
    <view 
      class="context-menu"
      style="left: {{contextMenu.x}}px; top: {{contextMenu.y}}px;"
      catchtap=""
    >
      <view 
        class="context-item"
        data-action="profile"
        bindtap="onContextAction"
      >
        <view class="context-icon">ğŸ‘¤</view>
        <text class="context-text">æŸ¥çœ‹èµ„æ–™</text>
      </view>
      
      <view class="context-divider"></view>
      
      <view 
        class="context-item"
        data-action="delete"
        bindtap="onContextAction"
      >
        <view class="context-icon">ğŸ—‘ï¸</view>
        <text class="context-text">åˆ é™¤æ¶ˆæ¯</text>
      </view>
      
      <view class="context-divider"></view>
      
      <view 
        class="context-item danger"
        data-action="block"
        bindtap="onContextAction"
      >
        <view class="context-icon">ğŸš«</view>
        <text class="context-text">å±è”½ç”¨æˆ·</text>
      </view>
    </view>
  </view>

  <!-- Tab Bar - Add this section for the tab bar -->
  <douyin-tabbar current="chat"></douyin-tabbar>
</view>