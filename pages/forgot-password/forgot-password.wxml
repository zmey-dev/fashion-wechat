<!-- Forgot Password Page -->
<view class="forgot-password-container">
  <!-- Loading State -->
  <view wx:if="{{sendingPhoneCode || sendingEmailCode}}" class="loading-container">
    <image class="loading-logo" src="/images/logo.png" mode="aspectFit"></image>
    <view class="loading-progress-bar">
      <view class="loading-progress-fill"></view>
    </view>
    <text class="loading-text">发送中...</text>
  </view>
  <!-- Header -->
  <view class="header">
    <view class="back-btn" bindtap="goBack">
      <image src="../../images/icons/chevron-left.svg" mode="aspectFit"></image>
    </view>
    <text class="page-title">{{pageTitle}}</text>
  </view>

  <!-- Success Page -->
  <view wx:if="{{resetSuccess}}" class="success-container">
    <view class="success-icon">
      <image src="../../images/icons/check.svg" mode="aspectFit"></image>
    </view>
    <view class="success-title">密码重置成功</view>
    <view class="success-message">您的密码已成功重置，现在可以使用新密码登录</view>
    <view class="success-button" bindtap="backToLogin">
      <text>返回登录</text>
    </view>
  </view>

  <!-- Forgot Password Flow -->
  <view wx:else class="content">
    <!-- Step 1: Method Selection -->
    <view wx:if="{{resetStep === 1}}" class="step-container">
      <!-- Tab Navigation -->
      <view class="tab-container">
        <view 
          class="tab {{resetMethod === 'phone' ? 'active' : ''}}"
          data-method="phone"
          bindtap="switchResetMethod"
        >
          手机号码验证
        </view>
        <view 
          class="tab {{resetMethod === 'email' ? 'active' : ''}}"
          data-method="email"
          bindtap="switchResetMethod"
        >
          邮箱验证
        </view>
      </view>

      <!-- Phone Reset Method -->
      <view wx:if="{{resetMethod === 'phone'}}" class="method-container">
        <view class="instruction">
          请输入您的手机号码，我们将发送验证码以重置密码
        </view>

        <view class="input-container">
          <view class="phone-input">
            <text class="phone-prefix">+86</text>
            <input 
              class="phone-number-input"
              type="number"
              placeholder="手机号码"
              value="{{phone}}"
              bindinput="onPhoneInput"
            />
          </view>
        </view>

        <!-- Phone Alerts and Errors -->
        <view wx:if="{{errors.phoneAlert}}" class="alert-message success">
          <text>{{errors.phoneAlert}}</text>
        </view>
        <view wx:if="{{errors.phone}}" class="alert-message error">
          <text>{{errors.phone}}</text>
        </view>

        <view 
          class="send-button"
          bindtap="sendPhoneCode"
        >
          <text wx:if="{{sendingPhoneCode}}">发送中...</text>
          <text wx:elif="{{isCountdownActive}}">{{countdown}}秒后重新发送</text>
          <text wx:else>发送验证码</text>
        </view>
      </view>

      <!-- Email Reset Method -->
      <view wx:if="{{resetMethod === 'email'}}" class="method-container">
        <view class="instruction">
          请输入您的电子邮箱地址，我们将发送验证码以重置密码
        </view>

        <view class="input-container">
          <view class="email-input-container">
            <input 
              class="email-input"
              type="text"
              placeholder="电子邮箱"
              value="{{emailForReset}}"
              bindinput="onEmailInput"
            />
          </view>
        </view>

        <!-- Email Alerts and Errors -->
        <view wx:if="{{errors.emailAlert}}" class="alert-message success">
          <text>{{errors.emailAlert}}</text>
        </view>
        <view wx:if="{{errors.email}}" class="alert-message error">
          <text>{{errors.email}}</text>
        </view>

        <view 
          class="send-button"
          bindtap="sendEmailCode"
        >
          <text wx:if="{{sendingEmailCode}}">发送中...</text>
          <text wx:elif="{{isCountdownActive}}">{{countdown}}秒后重新发送</text>
          <text wx:else>发送验证码</text>
        </view>
      </view>

      <view class="back-link" bindtap="handleBackToLogin">
        <text>返回登录</text>
      </view>
    </view>

    <!-- Step 2: Code Verification -->
    <view wx:if="{{resetStep === 2}}" class="step-container">
      <view wx:if="{{resetMethod === 'phone'}}" class="verification-container">
        <view class="instruction">
          验证码已发送至 +86{{phone}}，请输入验证码
        </view>

        <view class="code-input-container">
          <input 
            class="code-input"
            type="number"
            placeholder="请输入验证码"
            value="{{phoneCode}}"
            bindinput="onCodeInput"
            maxlength="6"
          />
          <view 
            class="resend-btn {{sendingPhoneCode || isCountdownActive ? 'disabled' : ''}}"
            bindtap="sendPhoneCode"
          >
            <text wx:if="{{sendingPhoneCode}}">发送中...</text>
            <text wx:elif="{{isCountdownActive}}">{{countdown}}秒后重新发送</text>
            <text wx:else>重新发送</text>
          </view>
        </view>

        <!-- Phone Alerts and Errors -->
        <view wx:if="{{errors.phoneAlert}}" class="alert-message success">
          <text>{{errors.phoneAlert}}</text>
        </view>
        <view wx:if="{{errors.phone}}" class="alert-message error">
          <text>{{errors.phone}}</text>
        </view>
      </view>

      <view wx:if="{{resetMethod === 'email'}}" class="verification-container">
        <view class="instruction">
          验证码已发送至 {{emailForReset}}，请输入验证码
        </view>

        <view class="code-input-container">
          <input 
            class="code-input"
            type="number"
            placeholder="请输入验证码"
            value="{{emailCodeForReset}}"
            bindinput="onCodeInput"
            maxlength="6"
          />
          <view 
            class="resend-btn {{sendingEmailCode || isCountdownActive ? 'disabled' : ''}}"
            bindtap="sendEmailCode"
          >
            <text wx:if="{{sendingEmailCode}}">发送中...</text>
            <text wx:elif="{{isCountdownActive}}">{{countdown}}秒后重新发送</text>
            <text wx:else>重新发送</text>
          </view>
        </view>

        <!-- Email Alerts and Errors -->
        <view wx:if="{{errors.emailAlert}}" class="alert-message success">
          <text>{{errors.emailAlert}}</text>
        </view>
        <view wx:if="{{errors.email}}" class="alert-message error">
          <text>{{errors.email}}</text>
        </view>
      </view>

      <view class="verify-button" bindtap="verifyCode">
        <text>下一步</text>
      </view>

      <view class="back-link" bindtap="goToPreviousStep">
        <text>返回上一步</text>
      </view>
    </view>

    <!-- Step 3: New Password -->
    <view wx:if="{{resetStep === 3}}" class="step-container">
      <view class="instruction">
        请设置您的新密码
      </view>

      <view class="password-container">
        <view class="password-field">
          <input 
            class="password-input"
            password="{{true}}"
            placeholder="请输入新密码"
            value="{{newPassword}}"
            bindinput="onNewPasswordInput"
          />
        </view>

        <view class="password-field">
          <input 
            class="password-input"
            password="{{true}}"
            placeholder="请确认新密码"
            value="{{confirmPassword}}"
            bindinput="onConfirmPasswordInput"
          />
        </view>
      </view>

      <!-- Password Error -->
      <view wx:if="{{errors.password}}" class="alert-message error">
        <text>{{errors.password}}</text>
      </view>

      <view class="reset-button" bindtap="resetPassword">
        <text>重置密码</text>
      </view>

      <view class="back-link" bindtap="goToPreviousStep">
        <text>返回上一步</text>
      </view>
    </view>
  </view>
</view>