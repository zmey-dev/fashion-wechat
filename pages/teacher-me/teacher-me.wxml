<wxs src="../../utils/userDisplayName.wxs" module="userUtils" />
<app-layout current-page="me">
  
  <view class="container" wx:if="{{!isLoading}}">
    <!-- Page header with tabs -->
    <view class="header">
      <view class="tab-container">
        <view 
          wx:for="{{tabs}}" 
          wx:key="index" 
          data-tab="{{index}}"
          bindtap="switchTab"
          class="tab {{currentTab === index ? 'active' : ''}}"
        >
          {{item}}
        </view>
      </view>    </view>

    <!-- Scroll container for all content below header -->
    <scroll-view 
      class="scroll-content" 
      scroll-y="{{true}}" 
      enhanced="{{true}}" 
      show-scrollbar="{{false}}"
    >
      <!-- Student Management Tab -->
      <block wx:if="{{currentTab === 0}}">
    <block wx:if="{{!selectedStudent}}">
      <!-- Filter Toggle Button -->
      <view class="filter-toggle-btn" bindtap="toggleFilters">
        <image src="../../images/icons/filter.svg" mode="aspectFit" class="filter-icon"></image>
        <text>{{showFilters ? 'éšè—ç­›é€‰' : 'æ˜¾ç¤ºç­›é€‰'}}</text>
      </view>
      
      <!-- Filter Section -->
      <view wx:if="{{showFilters}}" class="filter-section">
        <view class="filter-header">
          <text class="filter-title">ç­›é€‰å­¦ç”Ÿ</text>
          <view wx:if="{{activeFilters.faculty_id || activeFilters.major_id || activeFilters.attend_year}}" 
                class="clear-all-btn" 
                bindtap="clearAllFilters">
            <text>æ¸…é™¤æ‰€æœ‰</text>
          </view>
        </view>
        
        <!-- Filter Dropdowns -->
        <view class="filter-controls">
          <!-- Faculty Filter -->
          <view class="filter-dropdown">
            <view class="dropdown-header" bindtap="toggleFilterDropdown" data-type="faculty">
              <text class="dropdown-label">å­¦é™¢</text>
              <text class="dropdown-value">{{filterDisplayValues.faculty}}</text>
              <image src="../../images/icons/chevron-down.svg" 
                     mode="aspectFit" 
                     class="dropdown-arrow {{filterDropdowns.faculty ? 'rotate' : ''}}"></image>
            </view>
            
            <view wx:if="{{filterDropdowns.faculty}}" class="dropdown-content">
              <view class="dropdown-search">
                <input type="text" 
                       placeholder="æœç´¢å­¦é™¢..." 
                       value="{{filterSearchTerms.faculty}}"
                       bindinput="onFilterSearchInput"
                       data-type="faculty"
                       class="search-input" />
              </view>
              
              <scroll-view class="dropdown-options" scroll-y="true">
                <view class="dropdown-option {{!activeFilters.faculty ? 'selected' : ''}}"
                      bindtap="selectFilterOption"
                      data-type="faculty"
                      data-value="">
                  å…¨éƒ¨å­¦é™¢
                </view>
                <block wx:for="{{filters.faculties}}" wx:key="value">
                  <view wx:if="{{!filterSearchTerms.faculty || item.name.toLowerCase().indexOf(filterSearchTerms.faculty.toLowerCase()) !== -1}}"
                        class="dropdown-option {{activeFilters.faculty === item.value ? 'selected' : ''}}"
                        bindtap="selectFilterOption"
                        data-type="faculty"
                        data-value="{{item.value}}"
                        data-name="{{item.name}}">
                    {{item.name}}
                  </view>
                </block>
              </scroll-view>
            </view>
          </view>
          
          <!-- Major Filter -->
          <view class="filter-dropdown">
            <view class="dropdown-header" bindtap="toggleFilterDropdown" data-type="major">
              <text class="dropdown-label">ä¸“ä¸š</text>
              <text class="dropdown-value">{{filterDisplayValues.major}}</text>
              <image src="../../images/icons/chevron-down.svg" 
                     mode="aspectFit" 
                     class="dropdown-arrow {{filterDropdowns.major ? 'rotate' : ''}}"></image>
            </view>
            
            <view wx:if="{{filterDropdowns.major}}" class="dropdown-content">
              <view class="dropdown-search">
                <input type="text" 
                       placeholder="æœç´¢ä¸“ä¸š..." 
                       value="{{filterSearchTerms.major}}"
                       bindinput="onFilterSearchInput"
                       data-type="major"
                       class="search-input" />
              </view>
              
              <scroll-view class="dropdown-options" scroll-y="true">
                <view class="dropdown-option {{!activeFilters.major ? 'selected' : ''}}"
                      bindtap="selectFilterOption"
                      data-type="major"
                      data-value="">
                  å…¨éƒ¨ä¸“ä¸š
                </view>
                <block wx:for="{{filters.majors}}" wx:key="value">
                  <view wx:if="{{!filterSearchTerms.major || item.name.toLowerCase().indexOf(filterSearchTerms.major.toLowerCase()) !== -1}}"
                        class="dropdown-option {{activeFilters.major === item.value ? 'selected' : ''}}"
                        bindtap="selectFilterOption"
                        data-type="major"
                        data-value="{{item.value}}"
                        data-name="{{item.name}}">
                    {{item.name}}
                  </view>
                </block>
              </scroll-view>
            </view>
          </view>
          
          <!-- Attend Year Filter -->
          <view class="filter-dropdown">
            <view class="dropdown-header" bindtap="toggleFilterDropdown" data-type="year">
              <text class="dropdown-label">å…¥å­¦å¹´ä»½</text>
              <text class="dropdown-value">{{filterDisplayValues.year}}</text>
              <image src="../../images/icons/chevron-down.svg" 
                     mode="aspectFit" 
                     class="dropdown-arrow {{filterDropdowns.year ? 'rotate' : ''}}"></image>
            </view>
            
            <view wx:if="{{filterDropdowns.year}}" class="dropdown-content">
              <view class="dropdown-search">
                <input type="text" 
                       placeholder="æœç´¢å¹´ä»½..." 
                       value="{{filterSearchTerms.year}}"
                       bindinput="onFilterSearchInput"
                       data-type="year"
                       class="search-input" />
              </view>
              
              <scroll-view class="dropdown-options" scroll-y="true">
                <view class="dropdown-option {{!activeFilters.attend_year ? 'selected' : ''}}"
                      bindtap="selectFilterOption"
                      data-type="year"
                      data-value="">
                  å…¨éƒ¨å¹´ä»½
                </view>
                <block wx:for="{{filters.attend_years}}" wx:key="*this">
                  <view wx:if="{{!filterSearchTerms.year || item.toString().indexOf(filterSearchTerms.year) !== -1}}"
                        class="dropdown-option {{activeFilters.attend_year === item ? 'selected' : ''}}"
                        bindtap="selectFilterOption"
                        data-type="year"
                        data-value="{{item}}">
                    {{item}}
                  </view>
                </block>
              </scroll-view>
            </view>
          </view>
        </view>
        
        <!-- Active Filters Tags -->
        <view wx:if="{{activeFilters.faculty || activeFilters.major || activeFilters.attend_year}}" class="active-filters">
          <view wx:if="{{activeFilters.faculty}}" class="filter-tag">
            <text>{{filterDisplayValues.faculty}}</text>
            <view class="tag-close" bindtap="clearFilter" data-type="faculty">Ã—</view>
          </view>
          <view wx:if="{{activeFilters.major}}" class="filter-tag">
            <text>{{filterDisplayValues.major}}</text>
            <view class="tag-close" bindtap="clearFilter" data-type="major">Ã—</view>
          </view>
          <view wx:if="{{activeFilters.attend_year}}" class="filter-tag">
            <text>{{filterDisplayValues.year}}</text>
            <view class="tag-close" bindtap="clearFilter" data-type="year">Ã—</view>
          </view>
        </view>
      </view>
      
      <!-- Student List -->
      <view class="card section-title">
        <text>æˆ‘æ ¡å­¦ç”Ÿ</text>
      </view>
      
      <view class="student-list">
        <block wx:if="{{students.length > 0}}">
          <view 
            wx:for="{{students}}" 
            wx:key="id" 
            class="student-item"
            data-id="{{item.id}}"
            bindtap="selectStudent"
          >
            <view class="student-avatar">
              <image src="{{item.avatar || '../../images/icons/user.svg'}}" mode="aspectFill"></image>
            </view>
            <view class="student-info">
              <view class="student-name">{{item.name}}</view>
              <view class="student-detail">{{item.faculty || ''}} {{item.major || ''}}</view>
            </view>
            <view class="student-actions">
              <view 
                class="block-btn" 
                catchtap="blockStudent" 
                data-id="{{item.id}}"
              >
                <image src="../../images/icons/trash.svg" mode="aspectFit"></image>
              </view>
            </view>
          </view>
        </block>
          <view wx:else class="empty-state">
          <image src="../../images/icons/empty.svg" mode="aspectFit"></image>
          <text>{{messages.noStudents}}</text>
        </view>
      </view>
    </block>
    
    <block wx:else>
      <!-- Student Detail View -->
      <view class="action-bar">
        <view class="back-btn" bindtap="backToStudentList">
          <image src="../../images/icons/chevron-left.svg" mode="aspectFit"></image>
          <text>è¿”å›</text>
        </view>
        <view class="block-btn-top" catchtap="blockStudent" data-id="{{selectedStudent.id}}">
          <image src="../../images/icons/close.svg" mode="aspectFit"></image>
          <text>å µå¡</text>
        </view>
      </view>
      
      <!-- Student Profile Card -->
      <view class="student-profile-card">
        <view class="student-header">
          <avatar 
            class="student-avatar-large" 
            avatar="{{selectedStudent.avatar}}"
            user="{{selectedStudent}}"
            mode="aspectFill"
            size="160"
          ></avatar>
          <view class="student-name-large">{{userUtils.getDisplayName(selectedStudent)}}</view>
          <view class="student-username-container">
            <text class="student-username">{{userUtils.getFormattedDisplayName(selectedStudent)}}<text wx:if="{{userUtils.isCompany(selectedStudent)}}" class="company-badge">ä¼ä¸š</text></text>
          </view>
        </view>
        
        <view class="student-details">
          <view class="detail-row">
            <view class="detail-icon">
              <image src="../../images/icons/graduation-cap.svg" mode="aspectFit"></image>
            </view>
            <view class="detail-label">å­¦é™¢:</view>
            <view class="detail-value">{{selectedStudent.faculty || 'æœªè®¾ç½®'}}</view>
          </view>
          
          <view class="detail-row">
            <view class="detail-icon">
              <image src="../../images/icons/book-open.svg" mode="aspectFit"></image>
            </view>
            <view class="detail-label">ä¸“ä¸š:</view>
            <view class="detail-value">{{selectedStudent.major || 'æœªè®¾ç½®'}}</view>
          </view>
          
          <view class="detail-row">
            <view class="detail-icon">
              <image src="../../images/icons/users.svg" mode="aspectFit"></image>
            </view>
            <view class="detail-label">ç­çº§:</view>
            <view class="detail-value">{{selectedStudent.class || 'æœªè®¾ç½®'}}</view>
          </view>
          
          <view class="detail-row">
            <view class="detail-icon">
              <image src="../../images/icons/document-text.svg" mode="aspectFit"></image>
            </view>
            <view class="detail-label">èº«ä»½è¯:</view>
            <view class="detail-value">{{selectedStudent.id_number || 'æœªè®¾ç½®'}}</view>
          </view>
          
          <view class="detail-row">
            <view class="detail-icon">
              <image src="../../images/icons/document-text.svg" mode="aspectFit"></image>
            </view>
            <view class="detail-label">å­¦å·:</view>
            <view class="detail-value">{{selectedStudent.student_number || 'æœªè®¾ç½®'}}</view>
          </view>
          
          <view class="detail-row">
            <view class="detail-icon">
              <image src="../../images/icons/phone.svg" mode="aspectFit"></image>
            </view>
            <view class="detail-label">ç”µè¯:</view>
            <view class="detail-value">{{selectedStudent.phone || 'æœªè®¾ç½®'}}</view>
          </view>
          
          <!--
          <view class="detail-row">
            <view class="detail-icon">
              <image src="../../images/icons/mail.svg" mode="aspectFit"></image>
            </view>
            <view class="detail-label">é‚®ç®±:</view>
            <view class="detail-value">{{selectedStudent.email || 'æœªè®¾ç½®'}}</view>
          </view>* 
          -->
          
          <view class="detail-row">
            <view class="detail-icon">
              <image src="../../images/icons/calendar.svg" mode="aspectFit"></image>
            </view>
            <view class="detail-label">å…¥å­¦å¹´ä»½:</view>
            <view class="detail-value">{{selectedStudent.attend_year || 'æœªè®¾ç½®'}}</view>
          </view>
        </view>
      </view>
      
      <!-- Student Posts Section -->
      <view class="card section-title">
        <text>å­¦ç”Ÿä½œå“</text>
      </view>
      
      <view class="posts-grid">
        <block wx:if="{{studentPosts.length > 0}}">
          <view 
            wx:for="{{studentPosts}}" 
            wx:key="id" 
            class="post-card"
            data-post="{{item}}"
            data-index="{{index}}"
            data-id="{{item.id}}"
            bindtap="viewPost"
          >
            <!-- Media Content -->
            <view class="media-content">
              <image 
                wx:if="{{item.type !== 'video'}}"
                class="post-thumbnail" 
                src="{{(item.media && item.media[0] && item.media[0].url) ? item.media[0].url : (item.thumbnail || item.cover || '../../images/placeholder.png')}}" 
                mode="aspectFill"
                lazy-load="{{true}}"
              ></image>
              
              <image 
                wx:else
                class="post-thumbnail" 
                src="{{(item.media && item.media[0] && item.media[0].preview_url) ? item.media[0].preview_url : (item.thumbnail || item.cover || '../../images/placeholder.png')}}" 
                mode="aspectFill"
                lazy-load="{{true}}"
              ></image>
              
              <view wx:if="{{item.type === 'video'}}" class="video-indicator">
                <image src="../../images/icons/play.svg" class="video-icon" mode="aspectFit"></image>
              </view>
              
              <view wx:if="{{item.media && item.media.length > 1}}" class="multiple-indicator">
                <image src="../../images/icons/layers.svg" class="multiple-icon" mode="aspectFit"></image>
              </view>
            </view>
            
            <!-- Post Information -->
            <view class="post-info">
              <view class="post-title">{{item.title || 'æ— æ ‡é¢˜'}}</view>
              <view class="post-stats">
                <view class="stat-item">
                  <image src="../../images/icons/heart.svg" mode="aspectFit"></image>
                  <text>{{item.likes || 0}}</text>
                </view>
                <view class="stat-item">
                  <image src="../../images/icons/message.svg" mode="aspectFit"></image>
                  <text>{{(item.comments && item.comments.length) ? item.comments.length : 0}}</text>
                </view>
              </view>
            </view>
            
            <!-- Delete Button -->
            <view class="post-delete" catchtap="deletePost" data-id="{{item.id}}">
              <image src="../../images/icons/trash.svg" mode="aspectFit"></image>
            </view>
          </view>
        </block>
        
        <view wx:if="{{studentPosts.length === 0 && !loading}}" class="empty-state">
          <image src="../../images/icons/empty.svg" mode="aspectFit"></image>
          <text>{{messages.noPosts}}</text>
        </view>
      </view>
      
    </block>
  </block>

  <!-- University Management Tab -->
  <block wx:if="{{currentTab === 1}}">
    <block wx:if="{{!selectedFaculty}}">
      <!-- Faculty List View -->
      <view class="card section-title">
        <text>å­¦é™¢ä¸ä¸“ä¸šä¿¡æ¯</text>
      </view>
      
      <!-- University Info Card -->
      <view class="university-info-card">
        <view class="info-row">
          <text class="info-label">åç§°:</text>
          <text class="info-value">{{university.name || 'æœªè®¾ç½®'}}</text>
        </view>
        
        <view class="info-row">
          <text class="info-label">è”ç³»æ–¹å¼:</text>
          <text class="info-value">{{university.phoneNumber || 'æœªè®¾ç½®'}}</text>
        </view>
        
        <view class="info-row">
          <text class="info-label">åœ°å€:</text>
          <text class="info-value">{{university.address || 'æœªè®¾ç½®'}}</text>
        </view>
        
        <view class="info-row">
          <text class="info-label">åˆåŒ ID:</text>
          <text class="info-value">{{university.contract_id || 'æœªè®¾ç½®'}}</text>
          <view wx:if="{{university.contractName}}" class="view-contract" bindtap="viewContractImage">
            <image src="../../images/icons/eye.svg" mode="aspectFit"></image>
          </view>
        </view>
      </view>
      
      <!-- Faculty List Section -->
      <view class="card section-title">
        <text>å­¦é™¢ç®¡ç†</text>
        <view class="add-button" bindtap="toggleFacultyInput">
          <image src="../../images/icons/plus.svg" mode="aspectFit"></image>
        </view>
      </view>
      
      <!-- Faculty Input (conditionally shown) -->
      <view wx:if="{{showFacultyInput}}" class="input-section">
        <view class="input-row">
          <input 
            class="mobile-input" 
            placeholder="è¾“å…¥å­¦é™¢åç§°..." 
            value="{{newFacultyInput}}"
            bindinput="onFacultyInput"
          />
          <view class="input-actions">
            <view class="confirm-btn" bindtap="addFaculty">
              <image src="../../images/icons/check.svg" mode="aspectFit"></image>
            </view>
            <view class="cancel-btn" bindtap="toggleFacultyInput">
              <image src="../../images/icons/close.svg" mode="aspectFit"></image>
            </view>
          </view>
        </view>
      </view>
      
      <!-- Faculty List -->
      <view class="faculty-list">
        <block wx:if="{{university.faculties && university.faculties.length > 0}}">
          <view 
            wx:for="{{university.faculties}}" 
            wx:key="name" 
            class="faculty-item"
            data-faculty="{{item}}"
            bindtap="selectFaculty"
          >
            <view class="faculty-info">
              <view class="faculty-name">{{item.name}}</view>
              <view class="faculty-detail">
                <text class="major-count">{{item.majors.length || 0}} ä¸ªä¸“ä¸š</text>
                <view wx:if="{{item.hasIssues}}" class="warning-badge">
                  <image src="../../images/icons/info-circle.svg" mode="aspectFit"></image>
                  <text>éœ€è¦ä¸“ä¸š</text>
                </view>
              </view>
            </view>
            <view class="faculty-actions">
              <view 
                class="delete-btn" 
                catchtap="deleteFaculty" 
                data-faculty="{{item.name}}"
              >
                <image src="../../images/icons/trash.svg" mode="aspectFit"></image>
              </view>
            </view>
          </view>
        </block>
        <view wx:else class="empty-state">
          <image src="../../images/icons/graduation-cap.svg" mode="aspectFit"></image>
          <text>è¯·æ·»åŠ è‡³å°‘ä¸€ä¸ªå­¦é™¢</text>
        </view>
      </view>
      
      <!-- Save Button -->
      <view class="save-section">
        <button 
          class="save-button {{loading || hasValidationIssues ? 'disabled' : ''}}" 
          bindtap="saveUniversityData" 
          disabled="{{loading || hasValidationIssues}}"
        >
          <block wx:if="{{loading}}">
            <view class="button-spinner"></view>
            <text>ä¿å­˜ä¸­...</text>
          </block>
          <block wx:else>
            <image src="../../images/icons/check.svg" mode="aspectFit"></image>
            <text>ä¿å­˜</text>
          </block>
        </button>
        <!-- Validation Messages -->
        <view wx:if="{{hasValidationIssues}}" class="validation-message">
          <image src="../../images/icons/info-circle.svg" mode="aspectFit"></image>
          <text>è¯·ç¡®ä¿æ¯ä¸ªå­¦é™¢è‡³å°‘æœ‰ä¸€ä¸ªä¸“ä¸š</text>
        </view>
      </view>
    </block>
    
    <block wx:else>
      <!-- Faculty Detail View (Major Management) -->
      <view class="action-bar">
        <view class="back-btn" bindtap="backToFacultyList">
          <image src="../../images/icons/chevron-left.svg" mode="aspectFit"></image>
          <text>è¿”å›</text>
        </view>
        <view class="delete-btn-top" catchtap="deleteFaculty" data-faculty="{{selectedFaculty.name}}">
          <image src="../../images/icons/trash.svg" mode="aspectFit"></image>
          <text>åˆ é™¤å­¦é™¢</text>
        </view>
      </view>
      
      <!-- Faculty Profile Card -->
      <view class="faculty-profile-card">
        <view class="faculty-header">
          <view class="faculty-icon">
            <image src="../../images/icons/graduation-cap.svg" mode="aspectFit"></image>
          </view>
          <view class="faculty-name-large">{{selectedFaculty.name}}</view>
          <view class="major-count-large">{{selectedFaculty.majors.length || 0}} ä¸ªä¸“ä¸š</view>
        </view>
      </view>
      
      <!-- Major Management Section -->
      <view class="card section-title">
        <text>ä¸“ä¸šç®¡ç†</text>
        <view class="add-button" bindtap="toggleMajorInput">
          <image src="../../images/icons/plus.svg" mode="aspectFit"></image>
        </view>
      </view>
      
      <!-- Major Input (conditionally shown) -->
      <view wx:if="{{showMajorInput}}" class="input-section">
        <view class="input-row">
          <input 
            class="mobile-input" 
            placeholder="è¾“å…¥ä¸“ä¸šåç§°..." 
            value="{{newMajorInput}}"
            bindinput="onMajorInput"
          />
          <view class="input-actions">
            <view class="confirm-btn" bindtap="addMajor">
              <image src="../../images/icons/check.svg" mode="aspectFit"></image>
            </view>
            <view class="cancel-btn" bindtap="toggleMajorInput">
              <image src="../../images/icons/close.svg" mode="aspectFit"></image>
            </view>
          </view>
        </view>
      </view>
      
      <!-- Major List -->
      <view class="major-list">
        <block wx:if="{{selectedFaculty.majors && selectedFaculty.majors.length > 0}}">
          <view 
            wx:for="{{selectedFaculty.majors}}" 
            wx:key="name"
            class="major-item"
          >
            <view class="major-info">
              <view class="major-name">{{item.name}}</view>
            </view>
            <view class="major-actions">
              <view 
                class="delete-btn" 
                catchtap="deleteMajor" 
                data-faculty="{{selectedFaculty.name}}" 
                data-major="{{item.name}}"
              >
                <image src="../../images/icons/trash.svg" mode="aspectFit"></image>
              </view>
            </view>
          </view>
        </block>
        <view wx:else class="empty-state">
          <image src="../../images/icons/book-open.svg" mode="aspectFit"></image>
          <text>å°šæœªä¸ºæ­¤å­¦é™¢æ·»åŠ ä¸“ä¸š</text>
        </view>
      </view>
    </block>
  </block>

  <!-- Teacher Profile Tab -->
  <block wx:if="{{currentTab === 2}}">
    <view class="profile-tab-container">
      <!-- Profile Header Actions -->
      <view class="profile-actions">
        <view class="left-actions">
          <button 
            class="profile-action-btn edit-btn" 
            bindtap="toggleProfileEdit"
            wx:if="{{!isEditingProfile}}"
          >
            <text class="btn-icon">âœï¸</text>
            <text class="btn-text">ç¼–è¾‘èµ„æ–™</text>
          </button>
          
          <view class="edit-actions" wx:if="{{isEditingProfile}}">
            <button class="profile-action-btn save-btn" bindtap="saveProfile">
              <text class="btn-icon">âœ…</text>
              <text class="btn-text">ä¿å­˜</text>
            </button>
            <button class="profile-action-btn cancel-btn" bindtap="cancelProfileEdit">
              <text class="btn-icon">âŒ</text>
              <text class="btn-text">å–æ¶ˆ</text>
            </button>
          </view>
        </view>
        
        <!-- Hide logout button when editing -->
        <button 
          class="profile-action-btn logout-btn" 
          bindtap="handleLogout"
          wx:if="{{!isEditingProfile}}"
        >
          <text class="btn-icon">ğŸšª</text>
          <text class="btn-text">é€€å‡ºç™»å½•</text>
        </button>
      </view>

      <!-- Avatar Section -->
      <view class="avatar-section">
        <view class="avatar-container-large" bindtap="selectAvatar">
          <image 
            class="avatar-large" 
            src="{{selectedAvatar || teacherProfile.avatar || '../../images/icons/user.svg'}}" 
            mode="aspectFill"
          ></image>
          <view class="avatar-overlay" wx:if="{{isEditingProfile}}">
            <text class="avatar-edit-icon">ğŸ“·</text>
            <text class="avatar-edit-text">æ›´æ¢å¤´åƒ</text>
          </view>
          <view wx:if="{{uploadingAvatar}}" class="upload-loading">
            <view class="loading-spinner small"></view>
          </view>
        </view>
        <view class="avatar-info">
          <text class="avatar-name">{{userUtils.getDisplayName(teacherProfile)}}</text>
          <text class="avatar-university">{{university.name || 'æœªè®¾ç½®å¤§å­¦'}}</text>
        </view>
      </view>

      <!-- Profile Form -->
      <view class="profile-form">
        <!-- Basic Information -->
        <view class="form-section">
          <view class="section-title">åŸºæœ¬ä¿¡æ¯</view>
          
          <!-- Name -->
          <view class="form-field">
            <label class="field-label">å§“å</label>
            <div style="display: flex;">
              <input 
                class="field-input {{profileErrors.name ? 'error' : ''}}"
                value="{{teacherProfile.name}}"
                placeholder="è¯·è¾“å…¥å§“å"
                disabled="{{!isEditingProfile}}"
                data-field="name"
                bindinput="onProfileInputChange"
              />
            </div>
            <text class="error-text" wx:if="{{profileErrors.name}}">{{profileErrors.name}}</text>
          </view>

          <!-- Nickname -->
          <view class="form-field">
            <label class="field-label">æ˜µç§°</label>
            <div style="display: flex;">
              <input 
                class="field-input {{profileErrors.nickname ? 'error' : ''}}"
                value="{{teacherProfile.nickname}}"
                placeholder="è¯·è¾“å…¥æ˜µç§°"
                disabled="{{!isEditingProfile}}"
                data-field="nickname"
                bindinput="onProfileInputChange"
              />
            </div>
            <text class="error-text" wx:if="{{profileErrors.nickname}}">{{profileErrors.nickname}}</text>
          </view>

          <!-- Phone -->
          <view class="form-field">
            <label class="field-label">
              æ‰‹æœºå·
              <view class="verification-status" wx:if="{{phoneChanged && !phoneVerified}}">
                <text class="status-text">éœ€è¦éªŒè¯</text>
              </view>
            </label>
            <view class="phone-input">
              <text class="phone-prefix">+86</text>
              <input 
                class="field-input phone-number {{profileErrors.phone ? 'error' : ''}}"
                value="{{teacherProfile.phone}}"
                placeholder="è¯·è¾“å…¥æ‰‹æœºå·"
                disabled="{{!isEditingProfile}}"
                data-field="phone"
                bindinput="onProfileInputChange"
              />
              <div 
                class="verify-btn {{phoneChanged && !phoneVerified && !sendingPhoneCode && phoneCountdown === 0 ? '' : 'disabled'}}"
                bindtap="sendPhoneVerificationCode"
                wx:if="{{isEditingProfile}}"
              >
                <block wx:if="{{!phoneChanged}}">æœªä¿®æ”¹</block>
                <block wx:elif="{{phoneVerified}}">å·²éªŒè¯</block>
                <block wx:elif="{{sendingPhoneCode}}">
                  <view class="loading-spinner small"></view>
                  <text>å‘é€ä¸­</text>
                </block>
                <block wx:elif="{{phoneCountdown > 0}}">{{phoneCountdown}}ç§’åé‡è¯•</block>
                <block wx:else>è·å–éªŒè¯ç </block>
              </div>
            </view>
            
            <!-- Phone Verification Section -->
            <view wx:if="{{phoneChanged && !phoneVerified && isEditingProfile}}" class="verification-section">
              <view class="otp-input-container">
                <input 
                  class="otp-input"
                  placeholder="è¯·è¾“å…¥æ‰‹æœºéªŒè¯ç "
                  value="{{enteredPhoneCode}}"
                  bindinput="onPhoneOtpInput"
                />
                <button class="verify-code-btn" bindtap="verifyPhoneCode">
                  éªŒè¯
                </button>
              </view>
            </view>
            
            <!-- Success message -->
            <text class="success-text" wx:if="{{phoneSuccessMessage}}">{{phoneSuccessMessage}}</text>
            <!-- Error message -->
            <text class="error-text" wx:if="{{phoneErrorMessage}}">{{phoneErrorMessage}}</text>
            <text class="error-text" wx:if="{{profileErrors.phone}}">{{profileErrors.phone}}</text>
          </view>

          <!-- Email -->
          

          <!-- Gender -->
          <view class="form-field">
            <label class="field-label">æ€§åˆ«</label>
            <view class="gender-options">
              <view 
                class="gender-option {{teacherProfile.gender === 'male' ? 'selected' : ''}} {{!isEditingProfile ? 'disabled' : ''}}"
                data-field="gender"
                data-value="male"
                bindtap="{{isEditingProfile ? 'onGenderChange' : ''}}"
              >
                <text class="gender-icon">â™‚</text>
                <text class="gender-text">ç”·</text>
              </view>
              <view 
                class="gender-option {{teacherProfile.gender === 'female' ? 'selected' : ''}} {{!isEditingProfile ? 'disabled' : ''}}"
                data-field="gender"
                data-value="female"
                bindtap="{{isEditingProfile ? 'onGenderChange' : ''}}"
              >
                <text class="gender-icon">â™€</text>
                <text class="gender-text">å¥³</text>
              </view>
            </view>
            <text class="error-text" wx:if="{{profileErrors.gender}}">{{profileErrors.gender}}</text>
          </view>
        </view>

        <!-- Professional Information -->
        <view class="form-section">
          <view class="section-title">èŒä¸šä¿¡æ¯</view>
          
          <!-- ID Number -->
          <view class="form-field">
            <label class="field-label">èº«ä»½è¯å·</label>
            <input 
              class="field-input {{profileErrors.id_number ? 'error' : ''}}"
              value="{{teacherProfile.id_number}}"
              placeholder="è¯·è¾“å…¥èº«ä»½è¯å·"
              disabled="{{!isEditingProfile}}"
              data-field="id_number"
              bindinput="onProfileInputChange"
            />
            <text class="error-text" wx:if="{{profileErrors.id_number}}">{{profileErrors.id_number}}</text>
          </view>

          <!-- School Position -->
          <view class="form-field">
            <label class="field-label">å­¦æ ¡èŒä½</label>
            <input 
              class="field-input {{profileErrors.school_position ? 'error' : ''}}"
              value="{{teacherProfile.school_position}}"
              placeholder="è¯·è¾“å…¥å­¦æ ¡èŒä½"
              disabled="{{!isEditingProfile}}"
              data-field="school_position"
              bindinput="onProfileInputChange"
            />
            <text class="error-text" wx:if="{{profileErrors.school_position}}">{{profileErrors.school_position}}</text>
          </view>

          <!-- Credential -->
          <view class="form-field">
            <label class="field-label">èµ„æ ¼è¯ä¹¦</label>
            <input 
              class="field-input {{profileErrors.credential ? 'error' : ''}}"
              value="{{teacherProfile.credential}}"
              placeholder="è¯·è¾“å…¥èµ„æ ¼è¯ä¹¦"
              disabled="{{!isEditingProfile}}"
              data-field="credential"
              bindinput="onProfileInputChange"
            />
            <text class="error-text" wx:if="{{profileErrors.credential}}">{{profileErrors.credential}}</text>
          </view>

          <!-- Credential File Upload -->
          <view class="form-field credential-field">
            <label class="field-label">èµ„æ ¼è¯ä¹¦æ–‡ä»¶</label>
            
            <view wx:if="{{teacherProfile.credentialName}}" class="credential-display">
              <view class="credential-file">
                <image src="../../images/icons/file.svg" mode="aspectFit" class="file-icon"></image>
                <text>{{credentialFileName || 'è¯ä¹¦æ–‡ä»¶'}}</text>
              </view>
              <view class="credential-actions">
                <view class="view-btn" bindtap="viewCredentialFile">
                  <image src="../../images/icons/eye.svg" mode="aspectFit"></image>
                </view>
                <view wx:if="{{isEditingProfile}}" class="reupload-btn" bindtap="uploadCredential">
                  <text>é‡æ–°ä¸Šä¼ </text>
                </view>
              </view>
            </view>
            
            <view wx:else class="credential-upload">
              <view 
                wx:if="{{isEditingProfile}}" 
                class="upload-btn {{uploadingCredential ? 'uploading' : ''}}"
                bindtap="uploadCredential"
              >
                <view wx:if="{{uploadingCredential}}" class="loading-spinner small"></view>
                <image wx:else src="../../images/icons/upload.svg" mode="aspectFit" class="upload-icon"></image>
                <text>{{uploadingCredential ? 'ä¸Šä¼ ä¸­...' : 'ä¸Šä¼ æ•™å¸ˆèµ„æ ¼è¯'}}</text>
              </view>
              <text wx:else class="form-display">æœªä¸Šä¼ </text>
            </view>
            
            <view class="credential-hint">
              <text>æ”¯æŒPDFã€Wordæ–‡æ¡£æˆ–å›¾ç‰‡æ ¼å¼</text>
            </view>
          </view>
        </view>
      </view>
      
      <!-- Password Change Section -->
      <view class="form-section">
        <view class="section-title">å¯†ç ç®¡ç†</view>
        
        <view class="form-field">
          <label class="field-label">å½“å‰å¯†ç </label>
          <view class="input-wrapper">
            <input 
              class="field-input {{passwordErrors.old_password ? 'error' : ''}}"
              password="{{true}}"
              value="{{passwordForm.old_password}}"
              placeholder="è¯·è¾“å…¥å½“å‰å¯†ç "
              data-field="old_password"
              bindinput="onPasswordInputChange"
            />
          </view>
          <text class="error-text" wx:if="{{passwordErrors.old_password}}">{{passwordErrors.old_password}}</text>
        </view>

        <view class="form-field">
          <label class="field-label">æ–°å¯†ç </label>
          <view class="input-wrapper">
            <input 
              class="field-input {{passwordErrors.new_password ? 'error' : ''}}"
              password="{{true}}"
              value="{{passwordForm.new_password}}"
              placeholder="è¯·è¾“å…¥æ–°å¯†ç  (6-20ä½)"
              data-field="new_password"
              bindinput="onPasswordInputChange"
            />
          </view>
          <text class="error-text" wx:if="{{passwordErrors.new_password}}">{{passwordErrors.new_password}}</text>
        </view>

        <view class="form-field">
          <label class="field-label">ç¡®è®¤æ–°å¯†ç </label>
          <view class="input-wrapper">
            <input 
              class="field-input {{passwordErrors.new_password_confirmation ? 'error' : ''}}"
              password="{{true}}"
              value="{{passwordForm.new_password_confirmation}}"
              placeholder="è¯·å†æ¬¡è¾“å…¥æ–°å¯†ç "
              data-field="new_password_confirmation"
              bindinput="onPasswordInputChange"
            />
          </view>
          <text class="error-text" wx:if="{{passwordErrors.new_password_confirmation}}">{{passwordErrors.new_password_confirmation}}</text>
        </view>

        <!-- Change Password Button -->
        <view class="password-actions">
          <view class="action-button change-password-btn" bindtap="changePassword">
            <text class="button-label" wx:if="{{!passwordChanging}}">ä¿®æ”¹å¯†ç </text>
            <text class="button-label" wx:else>ä¿®æ”¹ä¸­...</text>
          </view>
        </view>

        <!-- Success/Error Messages -->
        <view wx:if="{{passwordMessage}}" class="success-message">
          <text>{{passwordMessage}}</text>
        </view>
        <view wx:if="{{passwordError}}" class="error-message">
          <text>{{passwordError}}</text>
        </view>
      </view>
      
      <!-- WeChat Linking Section -->
      <view wx:if="{{!isEditingProfile}}" class="wechat-section">
        <view class="section-title">
          <text>å¾®ä¿¡ç»‘å®š</text>
        </view>
        <view class="wechat-status">
          <view class="wechat-info">
            <view class="wechat-icon">
              <image src="../../images/icons/wechat.svg" mode="aspectFit"></image>
            </view>
            <view class="wechat-details">
              <view class="wechat-status-text">
                <text wx:if="{{isWechatLinked}}">å·²ç»‘å®šå¾®ä¿¡è´¦å·</text>
                <text wx:else>æœªç»‘å®šå¾®ä¿¡è´¦å·</text>
              </view>
              <view class="wechat-description" wx:if="{{!isWechatLinked}}">
                <text>ç»‘å®šå¾®ä¿¡è´¦å·åï¼Œå¯ä»¥ä½¿ç”¨å¾®ä¿¡å¿«é€Ÿç™»å½•</text>
              </view>
            </view>
          </view>
          <view class="wechat-action">
            <button 
              wx:if="{{!isWechatLinked}}" 
              class="wechat-btn link-btn"
              bindtap="linkWechat"
              disabled="{{wechatLinking}}"
            >
              <text wx:if="{{wechatLinking}}">ç»‘å®šä¸­...</text>
              <text wx:else>ç»‘å®šå¾®ä¿¡</text>
            </button>
            <button 
              wx:else 
              class="wechat-btn unlink-btn"
              bindtap="unlinkWechat"
              disabled="{{wechatLinking}}"
            >
              <text wx:if="{{wechatLinking}}">è§£ç»‘ä¸­...</text>
              <text wx:else>è§£ç»‘å¾®ä¿¡</text>
            </button>
          </view>
        </view>
      </view>
    </view>      
  </block>

  <!-- Contact Tab -->
  <block wx:if="{{currentTab === 3}}">
    <view class="contact-container">
      <view class="content">
        <view class="form-section">
          <view class="form-item">
            <text class="form-label">æ ‡é¢˜</text>
            <input 
              class="form-input" 
              placeholder="è¯·è¾“å…¥ç®€çŸ­çš„æ ‡é¢˜æè¿°æ‚¨çš„å»ºè®®" 
              value="{{contactForm.title}}" 
              data-field="title"
              bindinput="onContactInputChange"
            />
          </view>
          
          <view class="form-item">
            <text class="form-label">è¯¦ç»†æè¿°</text>
            <textarea 
              class="form-textarea" 
              placeholder="è¯·è¯¦ç»†æè¿°æ‚¨çš„å»ºè®®æˆ–é—®é¢˜ï¼Œä»¥ä¾¿æˆ‘ä»¬èƒ½æ›´å¥½åœ°ç†è§£å’Œæ”¹è¿›" 
              value="{{contactForm.description}}" 
              data-field="description"
              bindinput="onContactInputChange"
            />
          </view>
        </view>
        
        <button class="submit-button" bindtap="submitContact">
          <text class="submit-icon">ğŸ“¤</text>
          <text>æäº¤å»ºè®®</text>
        </button>
      </view>
    </view>
  </block>
    </scroll-view>
    
    <!-- Image Preview Modal -->
    <view wx:if="{{showImageModal}}" class="modal-overlay" bindtap="closeImageModal">
    <view class="modal-content" catchtap>
      <image src="{{previewImageUrl}}" mode="aspectFit" class="preview-image"></image>
      <view class="close-modal" bindtap="closeImageModal">
        <image src="../../images/icons/close.svg" mode="aspectFit"></image>
      </view>
    </view>
  </view>
  
  </view>
</app-layout>